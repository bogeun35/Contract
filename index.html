<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ì œíœ´ì  ê³„ì•½ì„œ ë°ì´í„° ì¶”ì¶œê¸°</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<style>
  @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;600;700&display=swap');
  * { margin: 0; padding: 0; box-sizing: border-box; }
  :root {
    --bg: #f5f6fa; --surface: #ffffff; --surface-hover: #f8f9fc;
    --border: #e2e5ed; --text: #1e2634; --text-dim: #5a6474; --text-muted: #98a1b0;
    --accent: #3b6cf7; --accent-light: #eef2ff; --accent-hover: #2c59e0;
    --success: #0ea55a; --success-bg: #edfaf3;
    --warning: #e5960b; --warning-bg: #fef8ec;
    --danger: #e5453d; --danger-bg: #fef0ef;
    --radius: 8px; --radius-sm: 6px;
    --shadow-sm: 0 1px 3px rgba(0,0,0,0.06); --shadow: 0 2px 8px rgba(0,0,0,0.08);
  }
  body { font-family: 'Noto Sans KR', -apple-system, sans-serif; background: var(--bg); color: var(--text); min-height: 100vh; line-height: 1.5; }
  .header { background: var(--surface); border-bottom: 1px solid var(--border); padding: 16px 32px; display: flex; align-items: center; justify-content: space-between; position: sticky; top: 0; z-index: 100; box-shadow: var(--shadow-sm); }
  .header-left { display: flex; align-items: center; gap: 12px; }
  .header-icon { width: 34px; height: 34px; background: var(--accent); border-radius: var(--radius-sm); display: flex; align-items: center; justify-content: center; font-size: 16px; color: #fff; }
  .header h1 { font-size: 16px; font-weight: 600; }
  .header h1 span { color: var(--text-muted); font-weight: 400; font-size: 12.5px; margin-left: 10px; }
  .header-actions { display: flex; gap: 8px; }
  .btn { display: inline-flex; align-items: center; gap: 6px; padding: 8px 16px; border: 1px solid var(--border); border-radius: var(--radius-sm); background: var(--surface); color: var(--text); font-family: inherit; font-size: 13px; font-weight: 500; cursor: pointer; transition: all 0.15s; white-space: nowrap; }
  .btn:hover { background: var(--surface-hover); border-color: #ccd1dc; }
  .btn-primary { background: var(--accent); border-color: var(--accent); color: #fff; }
  .btn-primary:hover { background: var(--accent-hover); }
  .btn-primary:disabled, .btn-success:disabled { opacity: 0.45; cursor: not-allowed; }
  .btn-success { background: var(--success); border-color: var(--success); color: #fff; font-weight: 600; }
  .btn-success:hover { background: #0c9450; }
  .btn-icon { font-size: 14px; line-height: 1; }
  .main { max-width: 1400px; margin: 0 auto; padding: 24px 32px; display: flex; flex-direction: column; gap: 18px; }
  .drop-zone { border: 2px dashed var(--border); border-radius: var(--radius); padding: 44px 24px; text-align: center; transition: all 0.2s; cursor: pointer; position: relative; background: var(--surface); }
  .drop-zone:hover, .drop-zone.drag-over { border-color: var(--accent); background: var(--accent-light); }
  .drop-icon { font-size: 36px; margin-bottom: 10px; }
  .drop-text { font-size: 14px; font-weight: 500; margin-bottom: 4px; }
  .drop-hint { font-size: 12px; color: var(--text-muted); }
  .drop-zone input[type="file"] { position: absolute; inset: 0; opacity: 0; cursor: pointer; }
  .stats-bar { display: flex; gap: 12px; flex-wrap: wrap; }
  .stat-card { background: var(--surface); border: 1px solid var(--border); border-radius: var(--radius); padding: 14px 20px; flex: 1; min-width: 140px; display: flex; align-items: center; gap: 12px; box-shadow: var(--shadow-sm); }
  .stat-icon { font-size: 20px; }
  .stat-label { font-size: 11px; color: var(--text-muted); font-weight: 500; }
  .stat-value { font-size: 22px; font-weight: 700; }
  .stat-value.success { color: var(--success); }
  .stat-value.warning { color: var(--warning); }
  .section { background: var(--surface); border: 1px solid var(--border); border-radius: var(--radius); overflow: hidden; box-shadow: var(--shadow-sm); }
  .section-header { display: flex; align-items: center; justify-content: space-between; padding: 12px 18px; border-bottom: 1px solid var(--border); background: #fafbfd; }
  .section-title { font-size: 13px; font-weight: 600; display: flex; align-items: center; gap: 8px; }
  .section-badge { background: var(--accent-light); color: var(--accent); font-size: 11px; font-weight: 600; padding: 2px 8px; border-radius: 10px; }
  .file-list { max-height: 200px; overflow-y: auto; }
  .file-item { display: flex; align-items: center; padding: 10px 18px; border-bottom: 1px solid #f0f1f5; gap: 12px; transition: background 0.1s; }
  .file-item:last-child { border-bottom: none; }
  .file-item:hover { background: #f8f9fc; }
  .file-num { font-size: 11px; color: var(--text-muted); min-width: 22px; text-align: center; }
  .file-name { flex: 1; font-size: 13px; font-weight: 500; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
  .file-size { font-size: 11px; color: var(--text-muted); }
  .file-status { font-size: 11.5px; padding: 2px 10px; border-radius: 10px; font-weight: 500; }
  .file-status.pending { background: #f0f1f5; color: var(--text-muted); }
  .file-status.processing { background: var(--warning-bg); color: var(--warning); }
  .file-status.done { background: var(--success-bg); color: var(--success); }
  .file-status.error { background: var(--danger-bg); color: var(--danger); }
  .file-remove { background: none; border: none; color: var(--text-muted); cursor: pointer; font-size: 15px; padding: 2px 6px; border-radius: 4px; }
  .file-remove:hover { background: var(--danger-bg); color: var(--danger); }
  .table-wrap { overflow-x: auto; overflow-y: auto; max-height: 420px; }
  .table-wrap table { width: 100%; border-collapse: collapse; font-size: 12.5px; min-width: 1100px; }
  .table-wrap thead { position: sticky; top: 0; z-index: 2; }
  .table-wrap th { background: #f5f6fa; color: var(--text-dim); font-weight: 600; font-size: 11px; padding: 10px 12px; text-align: left; white-space: nowrap; border-bottom: 2px solid var(--border); }
  .table-wrap td { padding: 9px 12px; border-bottom: 1px solid #f0f1f5; white-space: nowrap; max-width: 200px; overflow: hidden; text-overflow: ellipsis; }
  .table-wrap tr:hover td { background: #f8f9fc; }
  .table-wrap td.address { max-width: 280px; }
  .table-wrap .row-num { color: var(--text-muted); font-size: 11px; text-align: center; }
  .empty-state { padding: 50px 20px; text-align: center; color: var(--text-muted); font-size: 13px; }
  .empty-state .empty-icon { font-size: 32px; margin-bottom: 8px; opacity: 0.5; }
  .progress-bar { height: 3px; background: #eceef3; border-radius: 2px; overflow: hidden; display: none; }
  .progress-bar.active { display: block; }
  .progress-fill { height: 100%; background: linear-gradient(90deg, var(--accent), #6e8efb); border-radius: 2px; transition: width 0.3s; width: 0%; }
  .log-area { font-family: 'Consolas', monospace; font-size: 11.5px; padding: 12px 16px; max-height: 140px; overflow-y: auto; line-height: 1.65; color: var(--text-dim); background: #fafbfd; }
  .log-line.success { color: var(--success); }
  .log-line.error { color: var(--danger); }
  .log-line.info { color: var(--accent); }
  .log-time { color: var(--text-muted); margin-right: 6px; }
  .debug-area { display: none; padding: 12px 16px; max-height: 250px; overflow-y: auto; font-family: 'Consolas', monospace; font-size: 11px; line-height: 1.5; color: var(--text-dim); white-space: pre-wrap; word-break: break-all; background: #f5f6fa; border-bottom: 1px solid var(--border); }
  .debug-area.visible { display: block; }
  ::-webkit-scrollbar { width: 5px; height: 5px; }
  ::-webkit-scrollbar-track { background: transparent; }
  ::-webkit-scrollbar-thumb { background: #d4d7e0; border-radius: 3px; }
</style>
</head>
<body>
<div class="header">
  <div class="header-left">
    <div class="header-icon">ğŸ“„</div>
    <h1>ì œíœ´ì  ê³„ì•½ì„œ ì¶”ì¶œê¸°<span>ì‹ê¶ŒëŒ€ì¥ PDF â†’ Excel ë³€í™˜</span></h1>
  </div>
  <div class="header-actions">
    <button class="btn" onclick="clearAll()"><span class="btn-icon">ğŸ—‘ï¸</span> ì´ˆê¸°í™”</button>
    <button class="btn btn-primary" id="btnExtract" onclick="extractAll()" disabled><span class="btn-icon">âš¡</span> ì „ì²´ ì¶”ì¶œ</button>
    <button class="btn btn-success" id="btnDownload" onclick="downloadExcel()" disabled><span class="btn-icon">ğŸ“¥</span> ì—‘ì…€ ë‹¤ìš´ë¡œë“œ</button>
  </div>
</div>
<div class="main">
  <div class="drop-zone" id="dropZone">
    <div class="drop-icon">ğŸ“</div>
    <div class="drop-text">PDF íŒŒì¼ì„ ë“œë˜ê·¸í•˜ê±°ë‚˜ í´ë¦­í•˜ì—¬ ì„ íƒí•˜ì„¸ìš”</div>
    <div class="drop-hint">ì—¬ëŸ¬ íŒŒì¼ ë™ì‹œ ì„ íƒ ê°€ëŠ¥ Â· ì œíœ´ì  ì„œë¹„ìŠ¤ê³µê¸‰ ê³„ì•½ì„œ PDF</div>
    <input type="file" id="fileInput" accept=".pdf" multiple>
  </div>
  <div class="stats-bar">
    <div class="stat-card"><div class="stat-icon">ğŸ“„</div><div class="stat-info"><div class="stat-label">ë“±ë¡ íŒŒì¼</div><div class="stat-value" id="statTotal">0</div></div></div>
    <div class="stat-card"><div class="stat-icon">âœ…</div><div class="stat-info"><div class="stat-label">ì¶”ì¶œ ì„±ê³µ</div><div class="stat-value success" id="statSuccess">0</div></div></div>
    <div class="stat-card"><div class="stat-icon">âš ï¸</div><div class="stat-info"><div class="stat-label">ì‹¤íŒ¨</div><div class="stat-value warning" id="statFail">0</div></div></div>
  </div>
  <div class="section">
    <div class="section-header"><div class="section-title">ğŸ“‹ íŒŒì¼ ëª©ë¡ <span class="section-badge" id="fileBadge">0</span></div></div>
    <div class="progress-bar" id="progressBar"><div class="progress-fill" id="progressFill"></div></div>
    <div class="file-list" id="fileList"><div class="empty-state"><div class="empty-icon">ğŸ“‚</div>PDF íŒŒì¼ì„ ì¶”ê°€í•˜ë©´ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤</div></div>
  </div>
  <div class="section">
    <div class="section-header">
      <div class="section-title">ğŸ“Š ì¶”ì¶œ ê²°ê³¼ <span class="section-badge" id="resultBadge">0</span></div>
      <div style="display:flex;gap:8px;"><button class="btn" onclick="copyToClipboard()" id="btnCopy" style="display:none"><span class="btn-icon">ğŸ“‹</span> í´ë¦½ë³´ë“œ ë³µì‚¬</button></div>
    </div>
    <div class="table-wrap" id="tableWrap"><div class="empty-state"><div class="empty-icon">ğŸ“Š</div>ì¶”ì¶œ ê²°ê³¼ê°€ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤</div></div>
  </div>
  <div class="section">
    <div class="section-header">
      <div class="section-title">ğŸ“ ë¡œê·¸</div>
      <div style="display:flex;gap:8px;">
        <button class="btn" onclick="toggleDebug()" style="font-size:11px;padding:4px 10px">Raw í…ìŠ¤íŠ¸</button>
        <button class="btn" onclick="clearLog()" style="font-size:11px;padding:4px 10px">ì§€ìš°ê¸°</button>
      </div>
    </div>
    <div class="debug-area" id="debugArea"></div>
    <div class="log-area" id="logArea"></div>
  </div>
</div>

<script>
pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';

let pdfFiles = [], extractedData = [], lastRawText = '';

// ============================================================
// íŒŒì¼ ê´€ë¦¬ (ë“œë˜ê·¸ì•¤ë“œë¡­, ì„ íƒ, ì‚­ì œ)
// ============================================================
const dropZone = document.getElementById('dropZone');
const fileInput = document.getElementById('fileInput');
fileInput.addEventListener('change', e => { addFiles(e.target.files); fileInput.value = ''; });
dropZone.addEventListener('dragover', e => { e.preventDefault(); dropZone.classList.add('drag-over'); });
dropZone.addEventListener('dragleave', () => dropZone.classList.remove('drag-over'));
dropZone.addEventListener('drop', e => {
  e.preventDefault(); dropZone.classList.remove('drag-over');
  addFiles([...e.dataTransfer.files].filter(f => f.name.toLowerCase().endsWith('.pdf')));
});

function addFiles(files) {
  for (const file of files) {
    if (pdfFiles.some(f => f.name === file.name && f.size === file.size)) continue;
    pdfFiles.push({ file, name: file.name, size: file.size, status: 'pending' });
  }
  renderFileList(); updateStats();
  document.getElementById('btnExtract').disabled = pdfFiles.length === 0;
  log(`${files.length}ê°œ íŒŒì¼ ì¶”ê°€ (ì´ ${pdfFiles.length}ê°œ)`, 'info');
}
function removeFile(i) { pdfFiles.splice(i, 1); renderFileList(); updateStats(); document.getElementById('btnExtract').disabled = !pdfFiles.length; }
function formatSize(b) { return b < 1024 ? b+' B' : b < 1048576 ? (b/1024).toFixed(1)+' KB' : (b/1048576).toFixed(1)+' MB'; }
function renderFileList() {
  const el = document.getElementById('fileList');
  document.getElementById('fileBadge').textContent = pdfFiles.length;
  if (!pdfFiles.length) { el.innerHTML = '<div class="empty-state"><div class="empty-icon">ğŸ“‚</div>PDF íŒŒì¼ì„ ì¶”ê°€í•˜ë©´ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤</div>'; return; }
  el.innerHTML = pdfFiles.map((f,i) => `<div class="file-item"><span class="file-num">${i+1}</span><span class="file-icon">ğŸ“„</span><span class="file-name" title="${f.name}">${f.name}</span><span class="file-size">${formatSize(f.size)}</span><span class="file-status ${f.status}">${{pending:'ëŒ€ê¸°',processing:'ì²˜ë¦¬ì¤‘...',done:'ì™„ë£Œ âœ“',error:'ì‹¤íŒ¨ âœ—'}[f.status]}</span><button class="file-remove" onclick="removeFile(${i})">âœ•</button></div>`).join('');
}
function updateStats() {
  document.getElementById('statTotal').textContent = pdfFiles.length;
  document.getElementById('statSuccess').textContent = extractedData.length;
  document.getElementById('statFail').textContent = pdfFiles.filter(f => f.status === 'error').length;
}

// ============================================================
// í•µì‹¬: PDFì—ì„œ ë°ì´í„° ì¶”ì¶œ
//
// ì „ëµ:
// 1) PDF.jsë¡œ ëª¨ë“  í…ìŠ¤íŠ¸ ì•„ì´í…œ(x, y, text) ìˆ˜ì§‘
// 2) Yì¢Œí‘œë¡œ ì¤„ ê·¸ë£¹í•‘ (Â±3 í—ˆìš©)
// 3) ê° ì¤„ ë‚´ Xì¢Œí‘œ ìˆœ ì •ë ¬ â†’ ê°„ê²© ê¸°ë°˜ ë‹¨ì–´ í•©ì¹˜ê¸°
// 4) "ê³„ì•½ì²´ê²°ì¼" ë¼ë²¨ì˜ Yì¢Œí‘œë¥¼ ê¸°ì¤€ì ìœ¼ë¡œ ì¡ê³ 
//    ìƒëŒ€ Yì˜¤í”„ì…‹ìœ¼ë¡œ ê° í•„ë“œì˜ ì¤„ì„ ì°¾ê¸°
// 5) ê° ì¤„ì—ì„œ ë¼ë²¨ í…ìŠ¤íŠ¸ ì œê±° â†’ ë‚˜ë¨¸ì§€ê°€ ê°’
// ============================================================
async function extractDataFromPDF(file) {
  const buf = await file.arrayBuffer();
  const pdf = await pdfjsLib.getDocument({ data: buf }).promise;

  // ê³„ì•½ì •ë³´ í˜ì´ì§€ ì°¾ê¸°
  let targetPage = null;
  for (let p = pdf.numPages; p >= 1; p--) {
    const pg = await pdf.getPage(p);
    const ct = await pg.getTextContent();
    const raw = ct.items.map(i => i.str).join('');
    if (raw.includes('ê³„ì•½ì²´ê²°ì¼') && raw.includes('ì€í–‰ëª…')) { targetPage = pg; break; }
  }
  if (!targetPage) targetPage = await pdf.getPage(pdf.numPages);

  const content = await targetPage.getTextContent();
  const items = content.items.filter(i => i.str.trim());

  // Step 1: ì•„ì´í…œ ìˆ˜ì§‘
  const all = items.map(i => ({
    x: Math.round(i.transform[4]),
    y: Math.round(i.transform[5]),
    w: i.width || 0,
    text: i.str
  }));

  // Step 2: Yì¢Œí‘œ ê·¸ë£¹í•‘ (Â±3 = ê°™ì€ ì¤„)
  all.sort((a, b) => b.y - a.y || a.x - b.x); // Y ë‚´ë¦¼ì°¨ìˆœ(ìœ„â†’ì•„ë˜)

  const lines = [];
  if (all.length === 0) return null;

  let curLine = [all[0]], curY = all[0].y;
  for (let i = 1; i < all.length; i++) {
    if (Math.abs(all[i].y - curY) <= 3) {
      curLine.push(all[i]);
    } else {
      lines.push(curLine);
      curLine = [all[i]];
      curY = all[i].y;
    }
  }
  lines.push(curLine);

  // Step 3: ê° ì¤„ì˜ í…ìŠ¤íŠ¸ í•©ì¹˜ê¸° (Xìˆœ, ê°„ê²© ê¸°ë°˜ ê³µë°±)
  const mergedLines = lines.map(line => {
    line.sort((a, b) => a.x - b.x);
    let text = '';
    for (let i = 0; i < line.length; i++) {
      if (i === 0) { text = line[i].text; continue; }
      const prev = line[i - 1];
      const gap = line[i].x - (prev.x + prev.w);
      // ê°„ê²© > 5px â†’ ê³µë°±, > 30px â†’ íƒ­(êµ¬ë¶„ì)
      if (gap > 30) text += '\t' + line[i].text;
      else if (gap > 5) text += ' ' + line[i].text;
      else text += line[i].text;
    }
    return { y: line[0].y, text: text.trim() };
  });

  // ë””ë²„ê·¸
  lastRawText = mergedLines.map(l => `y=${l.y} | ${l.text}`).join('\n');

  // Step 4: "ê³„ì•½ì²´ê²°ì¼" ê¸°ì¤€ì  ì°¾ê¸°
  const dateLineIdx = mergedLines.findIndex(l => l.text.includes('ê³„ì•½ì²´ê²°ì¼'));
  if (dateLineIdx < 0) return null;
  const baseY = mergedLines[dateLineIdx].y;

  // í—¬í¼: baseYë¡œë¶€í„° ìƒëŒ€ ì˜¤í”„ì…‹ ë²”ìœ„ë¡œ ì¤„ ì°¾ê¸°
  // PDF.js YëŠ” ìœ„ìª½ì´ í° ê°’ â†’ ì•„ë˜ë¡œ ê°ˆìˆ˜ë¡ Y ê°ì†Œ
  // offset ì–‘ìˆ˜ = ì•„ë˜ìª½
  function findLineByOffset(offsetMin, offsetMax) {
    return mergedLines.find(l => {
      const off = baseY - l.y;
      return off >= offsetMin && off <= offsetMax;
    });
  }

  // ë‘ PDFì—ì„œ í™•ì¸ëœ ìƒëŒ€ ì˜¤í”„ì…‹ (baseY=769 or 777 ê¸°ì¤€):
  // ìƒí˜¸/ëŒ€í‘œì: offset ~18 (yâ‰ˆ751)
  // ë§¤ì¥ì „í™”/íœ´ëŒ€ì „í™”: offset ~37 (yâ‰ˆ732)
  // ì£¼ì†Œ: offset ~55 (yâ‰ˆ714)
  // ì´ë©”ì¼: offset ~74 (yâ‰ˆ695)
  // ìš´ì˜ì‹œê°„: offset ~92 (yâ‰ˆ677)
  // -- ìš´ì˜íšŒì‚¬ êµ¬ê°„ ê±´ë„ˆëœ€ --
  // ì€í–‰ëª…: offset ~178 (yâ‰ˆ591)
  // ê³„ì¢Œë²ˆí˜¸: offset ~195 (yâ‰ˆ574)
  // ëª…ì˜ì£¼: offset ~210 (yâ‰ˆ559)
  // ì‚¬ì—…ìë²ˆí˜¸: offset ~226 (yâ‰ˆ543)

  const data = {};

  // ê³„ì•½ì²´ê²°ì¼
  const dateLine = mergedLines[dateLineIdx];
  const dm = dateLine.text.match(/(\d{4})\s*ë…„?\s*(\d{1,2})\s*ì›”?\s*(\d{1,2})\s*ì¼?/);
  data.contractDate = dm ? `${dm[1]}-${dm[2].padStart(2,'0')}-${dm[3].padStart(2,'0')}` : '';

  // ìƒí˜¸ / ëŒ€í‘œì (ê°™ì€ ì¤„, íƒ­ìœ¼ë¡œ êµ¬ë¶„ë˜ê±°ë‚˜ "ëŒ€í‘œì" í‚¤ì›Œë“œë¡œ ë¶„ë¦¬)
  const storeLine = findLineByOffset(14, 25);
  if (storeLine) {
    const st = storeLine.text;
    const repMatch = st.match(/ëŒ€í‘œì[\s\t]+(.+)/);
    const storeMatch = st.match(/ìƒ\s*í˜¸[\s\t]+(.+?)[\s\t]+ëŒ€í‘œì/);
    if (storeMatch) data.storeName = storeMatch[1].trim();
    else {
      // "ìƒ í˜¸" ì—†ì´ ê°’ë§Œ ìˆì„ ìˆ˜ë„ ìˆìŒ
      const parts = st.replace(/ìƒ\s*í˜¸/, '').split(/ëŒ€í‘œì/);
      if (parts[0]) data.storeName = parts[0].replace(/[\t]/g, ' ').trim();
    }
    if (repMatch) data.representative = repMatch[1].trim();
  }

  // ë§¤ì¥ì „í™” / íœ´ëŒ€ì „í™”
  const phoneLine = findLineByOffset(33, 42);
  if (phoneLine) {
    const pt = phoneLine.text;
    const storePhoneMatch = pt.match(/ë§¤ì¥ì „í™”ë²ˆí˜¸[\s\t]+([\d\-]+)/);
    const mobileMatch = pt.match(/íœ´ëŒ€ì „í™”ë²ˆí˜¸[\s\t]+([\d\-]+)/);
    data.storePhone = storePhoneMatch ? storePhoneMatch[1] : '';
    data.mobilePhone = mobileMatch ? mobileMatch[1] : '';
  }

  // ì£¼ì†Œ (ìš´ì˜íšŒì‚¬ ì£¼ì†Œ ì œì™¸)
  const addrLine = findLineByOffset(50, 62);
  if (addrLine) {
    let addr = addrLine.text.replace(/ì œíœ´ì /, '').replace(/ì£¼\s*ì†Œ/, '').replace(/[\t]/g, ' ').trim();
    // (ì¸) ì œê±°
    addr = addr.replace(/\(ì¸\)/, '').trim();
    if (addr.includes('ê°•ë‚¨êµ¬') || addr.includes('ë´‰ì€ì‚¬ë¡œ')) addr = ''; // ìš´ì˜íšŒì‚¬ ì£¼ì†Œë©´ ìŠ¤í‚µ
    data.address = addr;
  }

  // ì´ë©”ì¼
  const emailLine = findLineByOffset(68, 80);
  if (emailLine) {
    let em = emailLine.text.replace(/ì´ë©”ì¼ì£¼ì†Œ?/, '').replace(/[\t]/g, ' ').trim();
    const emailMatch = em.match(/([\w.\-]+@[\w.\-]+\.\w+)/);
    data.email = emailMatch ? emailMatch[1] : em;
  }

  // ìš´ì˜ì‹œê°„
  const timeLine = findLineByOffset(86, 100);
  if (timeLine) {
    data.operatingHours = timeLine.text.replace(/ìš´ì˜ì‹œê°„/, '').replace(/[\t]/g, ' ').trim();
  }

  // ì€í–‰ëª… (offset ~170~185)
  const bankLine = findLineByOffset(170, 190);
  if (bankLine) {
    data.bankName = bankLine.text.replace(/ì€í–‰ëª…/, '').replace(/[\t]/g, ' ').trim();
  }

  // ê³„ì¢Œë²ˆí˜¸ (offset ~190~205)
  const acctLine = findLineByOffset(190, 210);
  if (acctLine) {
    let acct = acctLine.text.replace(/ê³„ì¢Œë²ˆí˜¸/, '').replace(/[\t]/g, ' ').trim();
    data.accountNumber = acct;
  }

  // ëª…ì˜ì£¼ (offset ~205~220)
  const holderLine = findLineByOffset(205, 225);
  if (holderLine) {
    data.accountHolder = holderLine.text.replace(/ê³„ì¢Œ\s*ëª…ì˜ì£¼/, '').replace(/[\t]/g, ' ').trim();
  }

  // ì‚¬ì—…ìë²ˆí˜¸ (offset ~220~240)
  const bizLine = findLineByOffset(220, 245);
  if (bizLine) {
    let biz = bizLine.text.replace(/ì‚¬ì—…ì\s*ë“±ë¡ë²ˆí˜¸/, '').replace(/[\t]/g, ' ').trim();
    data.businessNumber = biz.replace(/-/g, '');
  }

  // ëˆ„ë½ ë³´ì •: ì˜¤í”„ì…‹ì´ ì•ˆ ë§ì„ ê²½ìš° í…ìŠ¤íŠ¸ ê¸°ë°˜ fallback
  if (!data.storeName || !data.bankName) {
    const allText = mergedLines.map(l => l.text).join('\n');
    if (!data.storeName) {
      const m = allText.match(/ìƒ\s*í˜¸[\s\t]+(.+?)[\s\t]*ëŒ€í‘œì/);
      if (m) data.storeName = m[1].trim();
    }
    if (!data.representative) {
      // ì¡°ì •í˜¸(ìš´ì˜íšŒì‚¬) ì œì™¸
      for (const l of mergedLines) {
        const m = l.text.match(/ëŒ€í‘œì[\s\t]+(\S+)/);
        if (m && m[1] !== 'ì¡°ì •í˜¸') { data.representative = m[1]; break; }
      }
    }
    if (!data.storePhone) {
      const m = allText.match(/ë§¤ì¥ì „í™”ë²ˆí˜¸[\s\t]+([\d\-]+)/);
      if (m) data.storePhone = m[1];
    }
    if (!data.mobilePhone) {
      const m = allText.match(/íœ´ëŒ€ì „í™”ë²ˆí˜¸[\s\t]+([\d\-]+)/);
      if (m) data.mobilePhone = m[1];
    }
    if (!data.address) {
      for (const l of mergedLines) {
        const m = l.text.match(/ì£¼\s*ì†Œ[\s\t]+(.+)/);
        if (m && !m[1].includes('ê°•ë‚¨êµ¬') && !m[1].includes('ë´‰ì€ì‚¬ë¡œ') && m[1].trim().length > 5) {
          data.address = m[1].replace(/ì œíœ´ì /, '').replace(/\(ì¸\)/, '').trim();
          break;
        }
      }
    }
    if (!data.email) {
      const m = allText.match(/([\w.\-]+@[\w.\-]+\.\w+)/);
      if (m) data.email = m[1];
    }
    if (!data.operatingHours) {
      const m = allText.match(/ìš´ì˜ì‹œê°„[\s\t]+(\S+)/);
      if (m) data.operatingHours = m[1];
    }
    if (!data.bankName) {
      const m = allText.match(/ì€í–‰ëª…[\s\t]+(\S+)/);
      if (m) data.bankName = m[1];
    }
    if (!data.accountNumber) {
      const m = allText.match(/ê³„ì¢Œë²ˆí˜¸[\s\t]+([\d\-]+)/);
      if (m) data.accountNumber = m[1];
    }
    if (!data.accountHolder) {
      const m = allText.match(/(?:ê³„ì¢Œ\s*)?ëª…ì˜ì£¼[\s\t]+(.+?)(?:\n|$)/);
      if (m) data.accountHolder = m[1].trim();
    }
    if (!data.businessNumber) {
      const m = allText.match(/ì‚¬ì—…ì\s*ë“±ë¡ë²ˆí˜¸[\s\t]+([\d\-]+)/);
      if (m) data.businessNumber = m[1].replace(/-/g, '');
    }
  }

  // ìµœì¢… ê²€ì‚¬
  const fields = ['contractDate','storeName','representative','storePhone','mobilePhone','address','email','operatingHours','bankName','accountNumber','accountHolder','businessNumber'];
  const missing = fields.filter(f => !data[f]);
  if (missing.length > 0) log(`  âš  ëˆ„ë½: ${missing.join(', ')}`, 'error');

  return data;
}

// ============================================================
// ì „ì²´ ì¶”ì¶œ
// ============================================================
async function extractAll() {
  if (!pdfFiles.length) return;
  const btn = document.getElementById('btnExtract');
  btn.disabled = true; btn.innerHTML = '<span class="btn-icon">â³</span> ì²˜ë¦¬ ì¤‘...';
  const pBar = document.getElementById('progressBar'), pFill = document.getElementById('progressFill');
  pBar.classList.add('active');
  extractedData = [];
  const total = pdfFiles.length;
  log(`ì¶”ì¶œ ì‹œì‘ - ${total}ê°œ íŒŒì¼`, 'info');

  for (let i = 0; i < total; i++) {
    const pf = pdfFiles[i];
    pf.status = 'processing'; renderFileList();
    pFill.style.width = `${(i/total)*100}%`;
    try {
      log(`[${i+1}/${total}] ${pf.name}`);
      const data = await extractDataFromPDF(pf.file);
      document.getElementById('debugArea').textContent = `=== ${pf.name} ===\n${lastRawText}`;
      if (data && (data.storeName || data.businessNumber || data.storePhone)) {
        data._fileName = pf.name; extractedData.push(data);
        pf.status = 'done'; log(`  âœ“ ${data.storeName || '(ìƒí˜¸ì—†ìŒ)'}`, 'success');
      } else { pf.status = 'error'; log(`  âœ— ë°ì´í„° ì—†ìŒ`, 'error'); }
    } catch (err) { pf.status = 'error'; log(`  âœ— ${err.message}`, 'error'); }
    renderFileList(); pFill.style.width = `${((i+1)/total)*100}%`;
  }
  renderResultTable(); updateStats();
  log(`ì™„ë£Œ! ì„±ê³µ: ${extractedData.length}/${total}`, extractedData.length ? 'success' : 'error');
  btn.disabled = false; btn.innerHTML = '<span class="btn-icon">âš¡</span> ì „ì²´ ì¶”ì¶œ';
  document.getElementById('btnDownload').disabled = !extractedData.length;
  setTimeout(() => pBar.classList.remove('active'), 1000);
}

// ============================================================
// í…Œì´ë¸” / ì—‘ì…€ / í´ë¦½ë³´ë“œ
// ============================================================
function renderResultTable() {
  const wrap = document.getElementById('tableWrap');
  document.getElementById('resultBadge').textContent = extractedData.length;
  const btnCopy = document.getElementById('btnCopy');
  if (!extractedData.length) { wrap.innerHTML = '<div class="empty-state"><div class="empty-icon">ğŸ“Š</div>ì¶”ì¶œ ê²°ê³¼ê°€ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤</div>'; btnCopy.style.display = 'none'; return; }
  btnCopy.style.display = '';
  const H = ['#','ì²´ê²°ì¼','ìƒí˜¸','ëŒ€í‘œì','ë§¤ì¥ì „í™”','íœ´ëŒ€ì „í™”','ì£¼ì†Œ','ì´ë©”ì¼','ìš´ì˜ì‹œê°„','ì€í–‰ëª…','ê³„ì¢Œë²ˆí˜¸','ëª…ì˜ì£¼','ì‚¬ì—…ìë²ˆí˜¸'];
  const K = ['contractDate','storeName','representative','storePhone','mobilePhone','address','email','operatingHours','bankName','accountNumber','accountHolder','businessNumber'];
  let html = '<table><thead><tr>' + H.map(h=>`<th>${h}</th>`).join('') + '</tr></thead><tbody>';
  extractedData.forEach((d,i) => {
    html += '<tr><td class="row-num">'+(i+1)+'</td>' + K.map(k=>`<td${k==='address'?' class="address"':''} title="${(d[k]||'').replace(/"/g,'&quot;')}">${d[k]||'-'}</td>`).join('') + '</tr>';
  });
  wrap.innerHTML = html + '</tbody></table>';
}
function downloadExcel() {
  if (!extractedData.length) return;
  const H = ['ì²´ê²°ì¼','ìƒí˜¸','ëŒ€í‘œì','ë§¤ì¥ì „í™”ë²ˆí˜¸','íœ´ëŒ€ì „í™”ë²ˆí˜¸','ì£¼ì†Œ','ì´ë©”ì¼','ìš´ì˜ì‹œê°„','ì€í–‰ëª…','ê³„ì¢Œë²ˆí˜¸','ëª…ì˜ì£¼','ì‚¬ì—…ìë²ˆí˜¸'];
  const K = ['contractDate','storeName','representative','storePhone','mobilePhone','address','email','operatingHours','bankName','accountNumber','accountHolder','businessNumber'];
  const ws = XLSX.utils.aoa_to_sheet([H, ...extractedData.map(d=>K.map(k=>d[k]||''))]);
  ws['!cols'] = [{wch:12},{wch:15},{wch:10},{wch:14},{wch:14},{wch:35},{wch:25},{wch:14},{wch:12},{wch:18},{wch:15},{wch:14}];
  const wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, ws, 'ì œíœ´ì  ê³„ì•½ ë°ì´í„°');
  const d = new Date();
  XLSX.writeFile(wb, `ì œíœ´ì _ê³„ì•½ì¶”ì¶œ_${d.getFullYear()}${String(d.getMonth()+1).padStart(2,'0')}${String(d.getDate()).padStart(2,'0')}.xlsx`);
  log('ì—‘ì…€ ë‹¤ìš´ë¡œë“œ ì™„ë£Œ', 'success');
}
function copyToClipboard() {
  if (!extractedData.length) return;
  const H = ['ì²´ê²°ì¼','ìƒí˜¸','ëŒ€í‘œì','ë§¤ì¥ì „í™”ë²ˆí˜¸','íœ´ëŒ€ì „í™”ë²ˆí˜¸','ì£¼ì†Œ','ì´ë©”ì¼','ìš´ì˜ì‹œê°„','ì€í–‰ëª…','ê³„ì¢Œë²ˆí˜¸','ëª…ì˜ì£¼','ì‚¬ì—…ìë²ˆí˜¸'];
  const K = ['contractDate','storeName','representative','storePhone','mobilePhone','address','email','operatingHours','bankName','accountNumber','accountHolder','businessNumber'];
  let tsv = H.join('\t')+'\n'; extractedData.forEach(d => tsv += K.map(k=>d[k]||'').join('\t')+'\n');
  navigator.clipboard.writeText(tsv).then(() => {
    log('í´ë¦½ë³´ë“œ ë³µì‚¬ ì™„ë£Œ', 'success');
    const b = document.getElementById('btnCopy'), o = b.innerHTML;
    b.innerHTML = '<span class="btn-icon">âœ…</span> ë³µì‚¬ë¨!'; setTimeout(()=>b.innerHTML=o, 1500);
  });
}

// ìœ í‹¸
function clearAll() {
  pdfFiles=[]; extractedData=[];
  renderFileList(); renderResultTable(); updateStats();
  document.getElementById('btnExtract').disabled = true;
  document.getElementById('btnDownload').disabled = true;
  document.getElementById('debugArea').textContent = '';
  log('ì´ˆê¸°í™”', 'info');
}
function log(msg, type='') {
  const a = document.getElementById('logArea'), now = new Date();
  const t = `${String(now.getHours()).padStart(2,'0')}:${String(now.getMinutes()).padStart(2,'0')}:${String(now.getSeconds()).padStart(2,'0')}`;
  const l = document.createElement('div'); l.className = `log-line ${type}`;
  l.innerHTML = `<span class="log-time">[${t}]</span>${msg}`;
  a.insertBefore(l, a.firstChild);
  while (a.children.length > 100) a.removeChild(a.lastChild);
}
function clearLog() { document.getElementById('logArea').innerHTML = ''; }
function toggleDebug() { document.getElementById('debugArea').classList.toggle('visible'); }
log('ì¤€ë¹„ ì™„ë£Œ', 'info');
</script>
</body>
</html>
