<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ì œíœ´ì  ê³„ì•½ì„œ ë°ì´í„° ì¶”ì¶œê¸°</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<style>
  @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;600;700&display=swap');

  * { margin: 0; padding: 0; box-sizing: border-box; }

  :root {
    --bg: #0f1117;
    --surface: #1a1d27;
    --surface-hover: #222633;
    --border: #2a2e3d;
    --border-active: #4a6cf7;
    --text: #e4e6ed;
    --text-dim: #8b8fa3;
    --text-muted: #5c6078;
    --accent: #4a6cf7;
    --accent-glow: rgba(74, 108, 247, 0.15);
    --success: #34d399;
    --success-bg: rgba(52, 211, 153, 0.1);
    --warning: #fbbf24;
    --warning-bg: rgba(251, 191, 36, 0.1);
    --danger: #f87171;
    --danger-bg: rgba(248, 113, 113, 0.1);
    --radius: 10px;
    --radius-sm: 6px;
  }

  body {
    font-family: 'Noto Sans KR', sans-serif;
    background: var(--bg);
    color: var(--text);
    min-height: 100vh;
    line-height: 1.5;
  }

  .header {
    background: var(--surface);
    border-bottom: 1px solid var(--border);
    padding: 20px 32px;
    display: flex;
    align-items: center;
    justify-content: space-between;
    position: sticky;
    top: 0;
    z-index: 100;
    backdrop-filter: blur(12px);
  }
  .header-left { display: flex; align-items: center; gap: 14px; }
  .header-icon {
    width: 38px; height: 38px;
    background: linear-gradient(135deg, var(--accent), #7c3aed);
    border-radius: var(--radius-sm);
    display: flex; align-items: center; justify-content: center;
    font-size: 18px;
  }
  .header h1 { font-size: 17px; font-weight: 600; letter-spacing: -0.3px; }
  .header h1 span { color: var(--text-dim); font-weight: 400; font-size: 13px; margin-left: 10px; }
  .header-actions { display: flex; gap: 10px; }

  .btn {
    display: inline-flex; align-items: center; gap: 7px;
    padding: 9px 18px;
    border: 1px solid var(--border); border-radius: var(--radius-sm);
    background: var(--surface); color: var(--text);
    font-family: inherit; font-size: 13px; font-weight: 500;
    cursor: pointer; transition: all 0.15s ease; white-space: nowrap;
  }
  .btn:hover { background: var(--surface-hover); border-color: var(--text-muted); }
  .btn-primary { background: var(--accent); border-color: var(--accent); color: #fff; }
  .btn-primary:hover { background: #3b5de7; }
  .btn-primary:disabled { opacity: 0.4; cursor: not-allowed; }
  .btn-success { background: var(--success); border-color: var(--success); color: #0f1117; font-weight: 600; }
  .btn-success:hover { background: #2bc48d; }
  .btn-success:disabled { opacity: 0.4; cursor: not-allowed; }
  .btn-icon { font-size: 15px; line-height: 1; }

  .main {
    max-width: 1400px;
    margin: 0 auto;
    padding: 24px 32px;
    display: flex; flex-direction: column; gap: 20px;
  }

  .drop-zone {
    border: 2px dashed var(--border); border-radius: var(--radius);
    padding: 48px 24px; text-align: center;
    transition: all 0.2s ease; cursor: pointer;
    position: relative; background: var(--surface);
  }
  .drop-zone:hover, .drop-zone.drag-over { border-color: var(--accent); background: var(--accent-glow); }
  .drop-zone.drag-over { transform: scale(1.005); }
  .drop-icon { font-size: 40px; margin-bottom: 12px; opacity: 0.7; }
  .drop-text { font-size: 15px; font-weight: 500; margin-bottom: 6px; }
  .drop-hint { font-size: 12px; color: var(--text-muted); }
  .drop-zone input[type="file"] { position: absolute; inset: 0; opacity: 0; cursor: pointer; }

  .stats-bar { display: flex; gap: 12px; flex-wrap: wrap; }
  .stat-card {
    background: var(--surface); border: 1px solid var(--border);
    border-radius: var(--radius-sm); padding: 14px 20px;
    flex: 1; min-width: 140px; display: flex; align-items: center; gap: 12px;
  }
  .stat-icon { font-size: 22px; opacity: 0.8; }
  .stat-info { display: flex; flex-direction: column; }
  .stat-label { font-size: 11px; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.5px; }
  .stat-value { font-size: 20px; font-weight: 700; letter-spacing: -0.5px; }
  .stat-value.success { color: var(--success); }
  .stat-value.warning { color: var(--warning); }

  .section {
    background: var(--surface); border: 1px solid var(--border);
    border-radius: var(--radius); overflow: hidden;
  }
  .section-header {
    display: flex; align-items: center; justify-content: space-between;
    padding: 14px 20px; border-bottom: 1px solid var(--border);
  }
  .section-title { font-size: 13px; font-weight: 600; display: flex; align-items: center; gap: 8px; }
  .section-badge {
    background: var(--accent-glow); color: var(--accent);
    font-size: 11px; font-weight: 600; padding: 2px 8px; border-radius: 10px;
  }

  .file-list { max-height: 200px; overflow-y: auto; }
  .file-item {
    display: flex; align-items: center; padding: 10px 20px;
    border-bottom: 1px solid var(--border); gap: 12px; transition: background 0.1s;
  }
  .file-item:last-child { border-bottom: none; }
  .file-item:hover { background: var(--surface-hover); }
  .file-num { font-size: 11px; color: var(--text-muted); min-width: 24px; text-align: center; }
  .file-icon { font-size: 16px; }
  .file-name { flex: 1; font-size: 13px; font-weight: 500; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
  .file-size { font-size: 11px; color: var(--text-muted); }
  .file-status { font-size: 12px; padding: 2px 10px; border-radius: 10px; font-weight: 500; }
  .file-status.pending { background: var(--surface-hover); color: var(--text-muted); }
  .file-status.processing { background: var(--warning-bg); color: var(--warning); }
  .file-status.done { background: var(--success-bg); color: var(--success); }
  .file-status.error { background: var(--danger-bg); color: var(--danger); }
  .file-remove {
    background: none; border: none; color: var(--text-muted);
    cursor: pointer; font-size: 16px; padding: 2px 6px;
    border-radius: 4px; transition: all 0.1s;
  }
  .file-remove:hover { background: var(--danger-bg); color: var(--danger); }

  .table-wrap { overflow-x: auto; overflow-y: auto; max-height: 420px; }
  .table-wrap table { width: 100%; border-collapse: collapse; font-size: 12.5px; min-width: 1100px; }
  .table-wrap thead { position: sticky; top: 0; z-index: 2; }
  .table-wrap th {
    background: #1e2130; color: var(--text-dim);
    font-weight: 600; font-size: 11px; text-transform: uppercase;
    letter-spacing: 0.4px; padding: 10px 12px; text-align: left;
    white-space: nowrap; border-bottom: 2px solid var(--border);
  }
  .table-wrap td {
    padding: 9px 12px; border-bottom: 1px solid var(--border);
    white-space: nowrap; max-width: 200px; overflow: hidden; text-overflow: ellipsis;
  }
  .table-wrap tr:hover td { background: var(--surface-hover); }
  .table-wrap td.address { max-width: 280px; }
  .table-wrap .row-num { color: var(--text-muted); font-size: 11px; text-align: center; min-width: 30px; }
  .empty-state { padding: 50px 20px; text-align: center; color: var(--text-muted); font-size: 13px; }
  .empty-state .empty-icon { font-size: 36px; margin-bottom: 10px; opacity: 0.5; }

  .progress-bar { height: 3px; background: var(--border); border-radius: 2px; overflow: hidden; display: none; }
  .progress-bar.active { display: block; }
  .progress-fill { height: 100%; background: linear-gradient(90deg, var(--accent), #7c3aed); border-radius: 2px; transition: width 0.3s ease; width: 0%; }

  .log-area {
    font-family: 'Consolas', 'Courier New', monospace;
    font-size: 11.5px; padding: 12px 16px;
    max-height: 120px; overflow-y: auto; line-height: 1.6; color: var(--text-dim);
  }
  .log-line.success { color: var(--success); }
  .log-line.error { color: var(--danger); }
  .log-line.info { color: var(--accent); }
  .log-time { color: var(--text-muted); margin-right: 6px; }

  /* Debug raw text viewer */
  .debug-toggle { font-size: 11px; padding: 4px 10px; }
  .debug-area {
    display: none; padding: 12px 16px; max-height: 200px; overflow-y: auto;
    font-family: 'Consolas', monospace; font-size: 11px; line-height: 1.5;
    color: var(--text-dim); white-space: pre-wrap; word-break: break-all;
    background: #13151e;
  }
  .debug-area.visible { display: block; }

  ::-webkit-scrollbar { width: 6px; height: 6px; }
  ::-webkit-scrollbar-track { background: transparent; }
  ::-webkit-scrollbar-thumb { background: var(--border); border-radius: 3px; }
  ::-webkit-scrollbar-thumb:hover { background: var(--text-muted); }

  @media (max-width: 768px) {
    .header { padding: 14px 16px; }
    .main { padding: 16px; }
    .header h1 span { display: none; }
  }
</style>
</head>
<body>

<div class="header">
  <div class="header-left">
    <div class="header-icon">ğŸ“„</div>
    <h1>ì œíœ´ì  ê³„ì•½ì„œ ì¶”ì¶œê¸°<span>ì‹ê¶ŒëŒ€ì¥ PDF â†’ Excel ë³€í™˜</span></h1>
  </div>
  <div class="header-actions">
    <button class="btn" onclick="clearAll()"><span class="btn-icon">ğŸ—‘ï¸</span> ì´ˆê¸°í™”</button>
    <button class="btn btn-primary" id="btnExtract" onclick="extractAll()" disabled><span class="btn-icon">âš¡</span> ì „ì²´ ì¶”ì¶œ</button>
    <button class="btn btn-success" id="btnDownload" onclick="downloadExcel()" disabled><span class="btn-icon">ğŸ“¥</span> ì—‘ì…€ ë‹¤ìš´ë¡œë“œ</button>
  </div>
</div>

<div class="main">
  <div class="drop-zone" id="dropZone">
    <div class="drop-icon">ğŸ“</div>
    <div class="drop-text">PDF íŒŒì¼ì„ ë“œë˜ê·¸í•˜ê±°ë‚˜ í´ë¦­í•˜ì—¬ ì„ íƒí•˜ì„¸ìš”</div>
    <div class="drop-hint">ì—¬ëŸ¬ íŒŒì¼ ë™ì‹œ ì„ íƒ ê°€ëŠ¥ Â· ì œíœ´ì  ì„œë¹„ìŠ¤ê³µê¸‰ ê³„ì•½ì„œ PDF</div>
    <input type="file" id="fileInput" accept=".pdf" multiple>
  </div>

  <div class="stats-bar">
    <div class="stat-card">
      <div class="stat-icon">ğŸ“„</div>
      <div class="stat-info"><div class="stat-label">ë“±ë¡ íŒŒì¼</div><div class="stat-value" id="statTotal">0</div></div>
    </div>
    <div class="stat-card">
      <div class="stat-icon">âœ…</div>
      <div class="stat-info"><div class="stat-label">ì¶”ì¶œ ì„±ê³µ</div><div class="stat-value success" id="statSuccess">0</div></div>
    </div>
    <div class="stat-card">
      <div class="stat-icon">âš ï¸</div>
      <div class="stat-info"><div class="stat-label">ì‹¤íŒ¨</div><div class="stat-value warning" id="statFail">0</div></div>
    </div>
  </div>

  <div class="section">
    <div class="section-header">
      <div class="section-title">ğŸ“‹ íŒŒì¼ ëª©ë¡ <span class="section-badge" id="fileBadge">0</span></div>
    </div>
    <div class="progress-bar" id="progressBar"><div class="progress-fill" id="progressFill"></div></div>
    <div class="file-list" id="fileList">
      <div class="empty-state"><div class="empty-icon">ğŸ“‚</div>PDF íŒŒì¼ì„ ì¶”ê°€í•˜ë©´ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤</div>
    </div>
  </div>

  <div class="section">
    <div class="section-header">
      <div class="section-title">ğŸ“Š ì¶”ì¶œ ê²°ê³¼ <span class="section-badge" id="resultBadge">0</span></div>
      <div style="display:flex;gap:8px;">
        <button class="btn" onclick="copyToClipboard()" id="btnCopy" style="display:none"><span class="btn-icon">ğŸ“‹</span> í´ë¦½ë³´ë“œ ë³µì‚¬</button>
      </div>
    </div>
    <div class="table-wrap" id="tableWrap">
      <div class="empty-state" id="emptyResult"><div class="empty-icon">ğŸ“Š</div>ì¶”ì¶œ ê²°ê³¼ê°€ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤</div>
    </div>
  </div>

  <div class="section">
    <div class="section-header">
      <div class="section-title">ğŸ“ ë¡œê·¸</div>
      <div style="display:flex;gap:8px;">
        <button class="btn debug-toggle" onclick="toggleDebug()">Raw í…ìŠ¤íŠ¸ ë³´ê¸°</button>
        <button class="btn" onclick="clearLog()" style="font-size:11px; padding: 4px 10px;">ì§€ìš°ê¸°</button>
      </div>
    </div>
    <div class="debug-area" id="debugArea"></div>
    <div class="log-area" id="logArea"></div>
  </div>
</div>

<script>
  pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';

  let pdfFiles = [];
  let extractedData = [];
  let lastRawText = '';

  // ============================================================
  // íŒŒì¼ ì…ë ¥ & ë“œë˜ê·¸ì•¤ë“œë¡­
  // ============================================================
  const dropZone = document.getElementById('dropZone');
  const fileInput = document.getElementById('fileInput');

  fileInput.addEventListener('change', (e) => { addFiles(e.target.files); fileInput.value = ''; });
  dropZone.addEventListener('dragover', (e) => { e.preventDefault(); dropZone.classList.add('drag-over'); });
  dropZone.addEventListener('dragleave', () => { dropZone.classList.remove('drag-over'); });
  dropZone.addEventListener('drop', (e) => {
    e.preventDefault(); dropZone.classList.remove('drag-over');
    addFiles([...e.dataTransfer.files].filter(f => f.type === 'application/pdf' || f.name.toLowerCase().endsWith('.pdf')));
  });

  function addFiles(files) {
    for (const file of files) {
      if (pdfFiles.some(f => f.name === file.name && f.size === file.size)) continue;
      pdfFiles.push({ file, name: file.name, size: file.size, status: 'pending' });
    }
    renderFileList(); updateStats();
    document.getElementById('btnExtract').disabled = pdfFiles.length === 0;
    log(`${files.length}ê°œ íŒŒì¼ ì¶”ê°€ë¨ (ì´ ${pdfFiles.length}ê°œ)`, 'info');
  }

  function removeFile(idx) {
    pdfFiles.splice(idx, 1); renderFileList(); updateStats();
    document.getElementById('btnExtract').disabled = pdfFiles.length === 0;
  }

  function formatSize(bytes) {
    if (bytes < 1024) return bytes + ' B';
    if (bytes < 1048576) return (bytes / 1024).toFixed(1) + ' KB';
    return (bytes / 1048576).toFixed(1) + ' MB';
  }

  function renderFileList() {
    const list = document.getElementById('fileList');
    document.getElementById('fileBadge').textContent = pdfFiles.length;
    if (pdfFiles.length === 0) {
      list.innerHTML = '<div class="empty-state"><div class="empty-icon">ğŸ“‚</div>PDF íŒŒì¼ì„ ì¶”ê°€í•˜ë©´ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤</div>';
      return;
    }
    list.innerHTML = pdfFiles.map((f, i) => `
      <div class="file-item">
        <span class="file-num">${i + 1}</span>
        <span class="file-icon">ğŸ“„</span>
        <span class="file-name" title="${f.name}">${f.name}</span>
        <span class="file-size">${formatSize(f.size)}</span>
        <span class="file-status ${f.status}">${
          f.status === 'pending' ? 'ëŒ€ê¸°' : f.status === 'processing' ? 'ì²˜ë¦¬ì¤‘...' :
          f.status === 'done' ? 'ì™„ë£Œ âœ“' : 'ì‹¤íŒ¨ âœ—'
        }</span>
        <button class="file-remove" onclick="removeFile(${i})" title="ì œê±°">âœ•</button>
      </div>
    `).join('');
  }

  function updateStats() {
    document.getElementById('statTotal').textContent = pdfFiles.length;
    document.getElementById('statSuccess').textContent = extractedData.length;
    document.getElementById('statFail').textContent = pdfFiles.filter(f => f.status === 'error').length;
  }

  // ============================================================
  // PDF í…ìŠ¤íŠ¸ ì¶”ì¶œ (PDF.js) - ê°œì„ ëœ ë²„ì „
  // í•µì‹¬: ê° í…ìŠ¤íŠ¸ ì•„ì´í…œì„ Yì¢Œí‘œë¡œ ì¤„ ê·¸ë£¹í•‘ í›„,
  //       Xì¢Œí‘œ ê°„ê²©ìœ¼ë¡œ ê³µë°±/íƒ­ì„ ì ì ˆíˆ ì‚½ì…í•˜ì—¬ ë¼ì¸ ì¬êµ¬ì„±
  // ============================================================
  async function extractTextFromPDF(file) {
    const arrayBuffer = await file.arrayBuffer();
    const pdf = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;
    const numPages = pdf.numPages;

    // "ê³„ì•½ì²´ê²°ì¼"ì´ í¬í•¨ëœ í˜ì´ì§€ ì°¾ê¸° (ë§ˆì§€ë§‰ë¶€í„° ì—­ìˆœ)
    let targetPage = null;
    for (let p = numPages; p >= 1; p--) {
      const page = await pdf.getPage(p);
      const content = await page.getTextContent();
      const rawText = content.items.map(it => it.str).join('');
      if (rawText.includes('ê³„ì•½ì²´ê²°ì¼') && rawText.includes('ì€í–‰ëª…')) {
        targetPage = page;
        break;
      }
    }

    if (!targetPage) {
      // ëª» ì°¾ìœ¼ë©´ ë§ˆì§€ë§‰ í˜ì´ì§€ ì‚¬ìš©
      targetPage = await pdf.getPage(numPages);
    }

    const content = await targetPage.getTextContent();
    const items = content.items;

    if (items.length === 0) return '';

    // 1ë‹¨ê³„: ëª¨ë“  ì•„ì´í…œì—ì„œ x, y, width, text ì¶”ì¶œ
    const allItems = [];
    for (const item of items) {
      if (!item.str || item.str.trim() === '') continue;
      const x = item.transform[4];
      const y = item.transform[5];
      const w = item.width || 0;
      allItems.push({ x, y, w, text: item.str });
    }

    // 2ë‹¨ê³„: Yì¢Œí‘œë¡œ ì¤„ ê·¸ë£¹í•‘ (Yê°’ ì°¨ì´ê°€ 3 ì´ë‚´ë©´ ê°™ì€ ì¤„)
    allItems.sort((a, b) => b.y - a.y || a.x - b.x);  // Y ë‚´ë¦¼ì°¨ìˆœ, X ì˜¤ë¦„ì°¨ìˆœ

    const lines = [];
    let currentLine = [allItems[0]];
    let currentY = allItems[0].y;

    for (let i = 1; i < allItems.length; i++) {
      const item = allItems[i];
      if (Math.abs(item.y - currentY) <= 3) {
        // ê°™ì€ ì¤„
        currentLine.push(item);
      } else {
        // ìƒˆ ì¤„
        lines.push([...currentLine]);
        currentLine = [item];
        currentY = item.y;
      }
    }
    lines.push(currentLine);

    // 3ë‹¨ê³„: ê° ì¤„ ë‚´ì—ì„œ Xì¢Œí‘œ ìˆœì„œë¡œ ì •ë ¬ í›„, ê°„ê²©ì— ë”°ë¼ í…ìŠ¤íŠ¸ í•©ì¹˜ê¸°
    const reconstructedLines = [];
    for (const line of lines) {
      line.sort((a, b) => a.x - b.x);

      let lineText = '';
      for (let i = 0; i < line.length; i++) {
        const item = line[i];
        if (i === 0) {
          lineText = item.text;
        } else {
          // ì´ì „ ì•„ì´í…œì˜ ë ìœ„ì¹˜ì™€ í˜„ì¬ ì•„ì´í…œ ì‹œì‘ ìœ„ì¹˜ì˜ ê°„ê²©
          const prevItem = line[i - 1];
          const prevEnd = prevItem.x + prevItem.w;
          const gap = item.x - prevEnd;

          // ê°„ê²©ì´ ì¶©ë¶„í•˜ë©´ ê³µë°± ì¶”ê°€ (í°íŠ¸ í¬ê¸°ì˜ ì•½ 30% ì´ìƒì´ë©´ ê³µë°±)
          if (gap > 3) {
            lineText += ' ' + item.text;
          } else {
            lineText += item.text;
          }
        }
      }
      reconstructedLines.push(lineText.trim());
    }

    return reconstructedLines.join('\n');
  }

  // ============================================================
  // ë°ì´í„° íŒŒì‹± - ê°œì„ ëœ ì •ê·œì‹
  // ============================================================
  function parseContractData(text) {
    const data = {};
    const lines = text.split('\n').map(l => l.trim()).filter(l => l);

    // ë””ë²„ê·¸ìš© raw text ì €ì¥
    lastRawText = text;

    // í—¬í¼: íŠ¹ì • í‚¤ì›Œë“œê°€ í¬í•¨ëœ ì¤„ ì°¾ê¸°
    function findLine(keyword) {
      return lines.find(l => l.includes(keyword)) || '';
    }
    function findLines(keyword) {
      return lines.filter(l => l.includes(keyword));
    }

    // ---- 1. ê³„ì•½ì²´ê²°ì¼ ----
    // íŒ¨í„´: "ê³„ì•½ì²´ê²°ì¼ 2026 ë…„ 2ì›” 3ì¼" ë˜ëŠ” "ê³„ì•½ì²´ê²°ì¼ 2026 ë…„ 2 3"
    const dateLine = findLine('ê³„ì•½ì²´ê²°ì¼');
    let m = dateLine.match(/(\d{4})\s*ë…„?\s*(\d{1,2})\s*ì›”?\s*(\d{1,2})\s*ì¼?/);
    if (!m) {
      // "2026 ë…„ ì›” ì¼" í˜•íƒœì—ì„œ ì›”/ì¼ì´ ë³„ë„ ì¤„ì— ìˆì„ ìˆ˜ ìˆìŒ
      // ì „ì²´ í…ìŠ¤íŠ¸ì—ì„œ ì‹œë„
      m = text.match(/ê³„ì•½ì²´ê²°ì¼[^\n]*?(\d{4})\s*ë…„?[\s\S]*?(\d{1,2})\s*ì›”?\s*(\d{1,2})\s*ì¼?/);
    }
    data.contractDate = m ? `${m[1]}-${m[2].padStart(2, '0')}-${m[3].padStart(2, '0')}` : '';

    // ---- 2. ìƒí˜¸ & ëŒ€í‘œì ----
    // ê°™ì€ ì¤„: "ìƒ í˜¸ ê³ ìƒ…ë§Œë‘ ëŒ€í‘œì ì „ìœ ì£¼"
    // ë˜ëŠ” ë³„ë„ ì¤„ì¼ ìˆ˜ ìˆìŒ
    const storeLine = findLine('ìƒ í˜¸') || findLine('ìƒí˜¸');
    m = storeLine.match(/ìƒ\s*í˜¸\s+(.+?)\s+ëŒ€í‘œì\s+(\S+)/);
    if (m) {
      data.storeName = m[1].trim();
      data.representative = m[2].trim();
    } else {
      // ìƒí˜¸ì™€ ëŒ€í‘œìê°€ ë‹¤ë¥¸ ì¤„ì— ìˆì„ ìˆ˜ ìˆìŒ
      // "ê³ ìƒ…ë§Œë‘" ê°™ì€ ê°’ì´ ìƒí˜¸ ë¼ë²¨ ê·¼ì²˜ì— ìˆìŒ
      data.storeName = '';
      data.representative = '';

      // ìƒí˜¸ ì¤„ì—ì„œ "ìƒ í˜¸" ì œê±°í•˜ê³  ë‚¨ì€ í…ìŠ¤íŠ¸
      if (storeLine) {
        let cleaned = storeLine.replace(/ìƒ\s*í˜¸/, '').trim();
        // "ëŒ€í‘œì" ì•ê¹Œì§€ê°€ ìƒí˜¸
        const repIdx = cleaned.indexOf('ëŒ€í‘œì');
        if (repIdx >= 0) {
          data.storeName = cleaned.substring(0, repIdx).trim();
          data.representative = cleaned.substring(repIdx + 3).trim();
        } else {
          data.storeName = cleaned;
        }
      }

      // ëŒ€í‘œìë¥¼ ë³„ë„ ì¤„ì—ì„œ ì°¾ê¸°
      if (!data.representative) {
        const repLine = findLines('ëŒ€í‘œì').find(l => !l.includes('ì¡°ì •í˜¸') && !l.includes('ìƒ í˜¸') && !l.includes('ìƒí˜¸'));
        if (repLine) {
          m = repLine.match(/ëŒ€í‘œì\s+(\S+)/);
          if (m && m[1] !== 'ì¡°ì •í˜¸') data.representative = m[1];
        }
        // ê·¸ë˜ë„ ì—†ìœ¼ë©´ ì²« ë²ˆì§¸ ëŒ€í‘œì ê°’ (ì¡°ì •í˜¸ ì œì™¸)
        if (!data.representative) {
          for (const l of findLines('ëŒ€í‘œì')) {
            m = l.match(/ëŒ€í‘œì\s+(\S+)/);
            if (m && m[1] !== 'ì¡°ì •í˜¸') { data.representative = m[1]; break; }
          }
        }
      }
    }

    // ---- 3. ë§¤ì¥ì „í™”ë²ˆí˜¸ ----
    const phoneLine = findLine('ë§¤ì¥ì „í™”ë²ˆí˜¸');
    m = phoneLine.match(/ë§¤ì¥ì „í™”ë²ˆí˜¸\s+([\d\-]+)/);
    data.storePhone = m ? m[1] : '';

    // ---- 4. íœ´ëŒ€ì „í™”ë²ˆí˜¸ ----
    m = (phoneLine || text).match(/íœ´ëŒ€ì „í™”ë²ˆí˜¸\s+([\d\-]+)/);
    data.mobilePhone = m ? m[1] : '';

    // ---- 5. ì£¼ì†Œ ----
    data.address = '';
    const addrLines = findLines('ì£¼ ì†Œ').concat(findLines('ì£¼ì†Œ'));
    for (const l of addrLines) {
      const addrMatch = l.match(/ì£¼\s*ì†Œ\s+(.+)/);
      if (addrMatch) {
        const addr = addrMatch[1].trim();
        // ìš´ì˜íšŒì‚¬ ì£¼ì†Œ ì œì™¸
        if (!addr.includes('ê°•ë‚¨êµ¬') && !addr.includes('ì‚¼ì„±ë™') && !addr.includes('ë´‰ì€ì‚¬ë¡œ') && addr.length > 5) {
          data.address = addr;
          break;
        }
      }
    }

    // ---- 6. ì´ë©”ì¼ ----
    const emailLine = findLine('ì´ë©”ì¼');
    m = emailLine.match(/ì´ë©”ì¼ì£¼ì†Œ?\s+(\S+@\S+)/);
    if (!m) m = text.match(/([\w.\-]+@[\w.\-]+\.\w+)/);
    data.email = m ? m[1] : '';

    // ---- 7. ìš´ì˜ì‹œê°„ ----
    const timeLine = findLine('ìš´ì˜ì‹œê°„');
    m = timeLine.match(/ìš´ì˜ì‹œê°„\s+(\S+)/);
    data.operatingHours = m ? m[1] : '';

    // ---- 8. ì€í–‰ëª… ----
    const bankLine = findLine('ì€í–‰ëª…');
    m = bankLine.match(/ì€í–‰ëª…\s+(\S+)/);
    data.bankName = m ? m[1] : '';

    // ---- 9. ê³„ì¢Œë²ˆí˜¸ ----
    const acctLine = findLine('ê³„ì¢Œë²ˆí˜¸');
    m = acctLine.match(/ê³„ì¢Œë²ˆí˜¸\s+([\d\-]+)/);
    data.accountNumber = m ? m[1] : '';

    // ---- 10. ëª…ì˜ì£¼ ----
    const holderLine = findLine('ëª…ì˜ì£¼');
    m = holderLine.match(/ëª…ì˜ì£¼\s+(\S+)/);
    data.accountHolder = m ? m[1] : '';

    // ---- 11. ì‚¬ì—…ìë²ˆí˜¸ ----
    const bizLine = findLine('ì‚¬ì—…ì');
    m = bizLine.match(/ì‚¬ì—…ì\s*ë“±ë¡ë²ˆí˜¸\s+([\d\-]+)/);
    data.businessNumber = m ? m[1].replace(/-/g, '') : '';

    // ë””ë²„ê·¸: ë¹ˆ ê°’ ì²´í¬
    const fields = ['contractDate','storeName','representative','storePhone','mobilePhone','address','email','operatingHours','bankName','accountNumber','accountHolder','businessNumber'];
    const missing = fields.filter(f => !data[f]);
    if (missing.length > 0) {
      log(`  âš  ëˆ„ë½ í•„ë“œ: ${missing.join(', ')}`, 'error');
    }

    return data;
  }

  // ============================================================
  // ì „ì²´ ì¶”ì¶œ
  // ============================================================
  async function extractAll() {
    if (pdfFiles.length === 0) return;

    const btnExtract = document.getElementById('btnExtract');
    btnExtract.disabled = true;
    btnExtract.innerHTML = '<span class="btn-icon">â³</span> ì²˜ë¦¬ ì¤‘...';

    const progressBar = document.getElementById('progressBar');
    const progressFill = document.getElementById('progressFill');
    progressBar.classList.add('active');

    extractedData = [];
    const total = pdfFiles.length;
    log(`ì¶”ì¶œ ì‹œì‘ - ì´ ${total}ê°œ íŒŒì¼`, 'info');

    for (let i = 0; i < total; i++) {
      const pf = pdfFiles[i];
      pf.status = 'processing';
      renderFileList();
      progressFill.style.width = `${((i) / total) * 100}%`;

      try {
        log(`[${i + 1}/${total}] ì²˜ë¦¬ ì¤‘: ${pf.name}`);
        const text = await extractTextFromPDF(pf.file);

        // ë””ë²„ê·¸ ì˜ì—­ì— raw text ì €ì¥
        document.getElementById('debugArea').textContent = `=== ${pf.name} ===\n${text}`;

        const data = parseContractData(text);

        if (data.storeName || data.businessNumber || data.storePhone) {
          data._fileName = pf.name;
          extractedData.push(data);
          pf.status = 'done';
          log(`  âœ“ ì¶”ì¶œ ì„±ê³µ: ${data.storeName || '(ìƒí˜¸ ì—†ìŒ)'}`, 'success');
        } else {
          pf.status = 'error';
          log(`  âœ— ë°ì´í„°ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŒ: ${pf.name}`, 'error');
        }
      } catch (err) {
        pf.status = 'error';
        log(`  âœ— ì˜¤ë¥˜: ${pf.name} - ${err.message}`, 'error');
      }

      renderFileList();
      progressFill.style.width = `${((i + 1) / total) * 100}%`;
    }

    renderResultTable(); updateStats();

    const successCount = extractedData.length;
    log(`ì¶”ì¶œ ì™„ë£Œ! ì„±ê³µ: ${successCount}ê°œ, ì‹¤íŒ¨: ${total - successCount}ê°œ`, successCount > 0 ? 'success' : 'error');

    btnExtract.disabled = false;
    btnExtract.innerHTML = '<span class="btn-icon">âš¡</span> ì „ì²´ ì¶”ì¶œ';
    document.getElementById('btnDownload').disabled = extractedData.length === 0;

    setTimeout(() => { progressBar.classList.remove('active'); }, 1000);
  }

  // ============================================================
  // ê²°ê³¼ í…Œì´ë¸” ë Œë”ë§
  // ============================================================
  function renderResultTable() {
    const wrap = document.getElementById('tableWrap');
    const badge = document.getElementById('resultBadge');
    const btnCopy = document.getElementById('btnCopy');
    badge.textContent = extractedData.length;

    if (extractedData.length === 0) {
      wrap.innerHTML = '<div class="empty-state"><div class="empty-icon">ğŸ“Š</div>ì¶”ì¶œ ê²°ê³¼ê°€ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤</div>';
      btnCopy.style.display = 'none';
      return;
    }
    btnCopy.style.display = '';

    const headers = ['#','ì²´ê²°ì¼','ìƒí˜¸','ëŒ€í‘œì','ë§¤ì¥ì „í™”','íœ´ëŒ€ì „í™”','ì£¼ì†Œ','ì´ë©”ì¼','ìš´ì˜ì‹œê°„','ì€í–‰ëª…','ê³„ì¢Œë²ˆí˜¸','ëª…ì˜ì£¼','ì‚¬ì—…ìë²ˆí˜¸'];
    const keys = ['contractDate','storeName','representative','storePhone','mobilePhone','address','email','operatingHours','bankName','accountNumber','accountHolder','businessNumber'];

    let html = '<table><thead><tr>';
    headers.forEach(h => { html += `<th>${h}</th>`; });
    html += '</tr></thead><tbody>';
    extractedData.forEach((d, i) => {
      html += '<tr>';
      html += `<td class="row-num">${i + 1}</td>`;
      keys.forEach(k => {
        const cls = k === 'address' ? ' class="address"' : '';
        html += `<td${cls} title="${(d[k]||'').replace(/"/g,'&quot;')}">${d[k] || '-'}</td>`;
      });
      html += '</tr>';
    });
    html += '</tbody></table>';
    wrap.innerHTML = html;
  }

  // ============================================================
  // ì—‘ì…€ ë‹¤ìš´ë¡œë“œ
  // ============================================================
  function downloadExcel() {
    if (extractedData.length === 0) return;
    const headers = ['ì²´ê²°ì¼','ìƒí˜¸','ëŒ€í‘œì','ë§¤ì¥ì „í™”ë²ˆí˜¸','íœ´ëŒ€ì „í™”ë²ˆí˜¸','ì£¼ì†Œ','ì´ë©”ì¼','ìš´ì˜ì‹œê°„','ì€í–‰ëª…','ê³„ì¢Œë²ˆí˜¸','ëª…ì˜ì£¼','ì‚¬ì—…ìë²ˆí˜¸'];
    const keys = ['contractDate','storeName','representative','storePhone','mobilePhone','address','email','operatingHours','bankName','accountNumber','accountHolder','businessNumber'];
    const wsData = [headers];
    extractedData.forEach(d => { wsData.push(keys.map(k => d[k] || '')); });

    const wb = XLSX.utils.book_new();
    const ws = XLSX.utils.aoa_to_sheet(wsData);
    ws['!cols'] = [{ wch:12 },{ wch:15 },{ wch:8 },{ wch:14 },{ wch:14 },{ wch:35 },{ wch:25 },{ wch:14 },{ wch:12 },{ wch:18 },{ wch:8 },{ wch:14 }];
    XLSX.utils.book_append_sheet(wb, ws, 'ì œíœ´ì  ê³„ì•½ ë°ì´í„°');

    const now = new Date();
    const ds = `${now.getFullYear()}${String(now.getMonth()+1).padStart(2,'0')}${String(now.getDate()).padStart(2,'0')}`;
    XLSX.writeFile(wb, `ì œíœ´ì _ê³„ì•½ì¶”ì¶œ_${ds}.xlsx`);
    log('ì—‘ì…€ íŒŒì¼ ë‹¤ìš´ë¡œë“œ ì™„ë£Œ', 'success');
  }

  // ============================================================
  // í´ë¦½ë³´ë“œ ë³µì‚¬
  // ============================================================
  function copyToClipboard() {
    if (extractedData.length === 0) return;
    const headers = ['ì²´ê²°ì¼','ìƒí˜¸','ëŒ€í‘œì','ë§¤ì¥ì „í™”ë²ˆí˜¸','íœ´ëŒ€ì „í™”ë²ˆí˜¸','ì£¼ì†Œ','ì´ë©”ì¼','ìš´ì˜ì‹œê°„','ì€í–‰ëª…','ê³„ì¢Œë²ˆí˜¸','ëª…ì˜ì£¼','ì‚¬ì—…ìë²ˆí˜¸'];
    const keys = ['contractDate','storeName','representative','storePhone','mobilePhone','address','email','operatingHours','bankName','accountNumber','accountHolder','businessNumber'];
    let tsv = headers.join('\t') + '\n';
    extractedData.forEach(d => { tsv += keys.map(k => d[k] || '').join('\t') + '\n'; });
    navigator.clipboard.writeText(tsv).then(() => {
      log('í´ë¦½ë³´ë“œì— ë³µì‚¬ ì™„ë£Œ (íƒ­ êµ¬ë¶„)', 'success');
      const btn = document.getElementById('btnCopy');
      const orig = btn.innerHTML;
      btn.innerHTML = '<span class="btn-icon">âœ…</span> ë³µì‚¬ë¨!';
      setTimeout(() => { btn.innerHTML = orig; }, 1500);
    });
  }

  // ============================================================
  // ìœ í‹¸
  // ============================================================
  function clearAll() {
    pdfFiles = []; extractedData = [];
    renderFileList(); renderResultTable(); updateStats();
    document.getElementById('btnExtract').disabled = true;
    document.getElementById('btnDownload').disabled = true;
    document.getElementById('debugArea').textContent = '';
    log('ì´ˆê¸°í™” ì™„ë£Œ', 'info');
  }

  function log(msg, type = '') {
    const area = document.getElementById('logArea');
    const now = new Date();
    const time = `${String(now.getHours()).padStart(2,'0')}:${String(now.getMinutes()).padStart(2,'0')}:${String(now.getSeconds()).padStart(2,'0')}`;
    const line = document.createElement('div');
    line.className = `log-line ${type}`;
    line.innerHTML = `<span class="log-time">[${time}]</span>${msg}`;
    area.insertBefore(line, area.firstChild);
    while (area.children.length > 100) area.removeChild(area.lastChild);
  }

  function clearLog() { document.getElementById('logArea').innerHTML = ''; }

  function toggleDebug() {
    const el = document.getElementById('debugArea');
    el.classList.toggle('visible');
  }

  log('PDF ì œíœ´ì  ê³„ì•½ì„œ ì¶”ì¶œê¸° ì¤€ë¹„ ì™„ë£Œ', 'info');
</script>
</body>
</html>
