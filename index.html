<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ì œíœ´ì  ê³„ì•½ì„œ ë°ì´í„° ì¶”ì¶œê¸°</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<style>
  @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;600;700&display=swap');

  * { margin: 0; padding: 0; box-sizing: border-box; }

  :root {
    --bg: #0f1117;
    --surface: #1a1d27;
    --surface-hover: #222633;
    --border: #2a2e3d;
    --border-active: #4a6cf7;
    --text: #e4e6ed;
    --text-dim: #8b8fa3;
    --text-muted: #5c6078;
    --accent: #4a6cf7;
    --accent-glow: rgba(74, 108, 247, 0.15);
    --success: #34d399;
    --success-bg: rgba(52, 211, 153, 0.1);
    --warning: #fbbf24;
    --warning-bg: rgba(251, 191, 36, 0.1);
    --danger: #f87171;
    --danger-bg: rgba(248, 113, 113, 0.1);
    --radius: 10px;
    --radius-sm: 6px;
  }

  body {
    font-family: 'Noto Sans KR', sans-serif;
    background: var(--bg);
    color: var(--text);
    min-height: 100vh;
    line-height: 1.5;
  }

  /* Header */
  .header {
    background: var(--surface);
    border-bottom: 1px solid var(--border);
    padding: 20px 32px;
    display: flex;
    align-items: center;
    justify-content: space-between;
    position: sticky;
    top: 0;
    z-index: 100;
    backdrop-filter: blur(12px);
  }
  .header-left {
    display: flex;
    align-items: center;
    gap: 14px;
  }
  .header-icon {
    width: 38px;
    height: 38px;
    background: linear-gradient(135deg, var(--accent), #7c3aed);
    border-radius: var(--radius-sm);
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 18px;
  }
  .header h1 {
    font-size: 17px;
    font-weight: 600;
    letter-spacing: -0.3px;
  }
  .header h1 span {
    color: var(--text-dim);
    font-weight: 400;
    font-size: 13px;
    margin-left: 10px;
  }
  .header-actions {
    display: flex;
    gap: 10px;
  }

  /* Buttons */
  .btn {
    display: inline-flex;
    align-items: center;
    gap: 7px;
    padding: 9px 18px;
    border: 1px solid var(--border);
    border-radius: var(--radius-sm);
    background: var(--surface);
    color: var(--text);
    font-family: inherit;
    font-size: 13px;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.15s ease;
    white-space: nowrap;
  }
  .btn:hover { background: var(--surface-hover); border-color: var(--text-muted); }
  .btn-primary {
    background: var(--accent);
    border-color: var(--accent);
    color: #fff;
  }
  .btn-primary:hover { background: #3b5de7; }
  .btn-primary:disabled {
    opacity: 0.4;
    cursor: not-allowed;
  }
  .btn-success {
    background: var(--success);
    border-color: var(--success);
    color: #0f1117;
    font-weight: 600;
  }
  .btn-success:hover { background: #2bc48d; }
  .btn-success:disabled { opacity: 0.4; cursor: not-allowed; }
  .btn-icon {
    font-size: 15px;
    line-height: 1;
  }

  /* Main Layout */
  .main {
    max-width: 1320px;
    margin: 0 auto;
    padding: 24px 32px;
    display: flex;
    flex-direction: column;
    gap: 20px;
  }

  /* Drop Zone */
  .drop-zone {
    border: 2px dashed var(--border);
    border-radius: var(--radius);
    padding: 48px 24px;
    text-align: center;
    transition: all 0.2s ease;
    cursor: pointer;
    position: relative;
    background: var(--surface);
  }
  .drop-zone:hover, .drop-zone.drag-over {
    border-color: var(--accent);
    background: var(--accent-glow);
  }
  .drop-zone.drag-over {
    transform: scale(1.005);
  }
  .drop-icon {
    font-size: 40px;
    margin-bottom: 12px;
    opacity: 0.7;
  }
  .drop-text {
    font-size: 15px;
    font-weight: 500;
    margin-bottom: 6px;
  }
  .drop-hint {
    font-size: 12px;
    color: var(--text-muted);
  }
  .drop-zone input[type="file"] {
    position: absolute;
    inset: 0;
    opacity: 0;
    cursor: pointer;
  }

  /* Stats bar */
  .stats-bar {
    display: flex;
    gap: 12px;
    flex-wrap: wrap;
  }
  .stat-card {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: var(--radius-sm);
    padding: 14px 20px;
    flex: 1;
    min-width: 140px;
    display: flex;
    align-items: center;
    gap: 12px;
  }
  .stat-icon {
    font-size: 22px;
    opacity: 0.8;
  }
  .stat-info { display: flex; flex-direction: column; }
  .stat-label { font-size: 11px; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.5px; }
  .stat-value { font-size: 20px; font-weight: 700; letter-spacing: -0.5px; }
  .stat-value.success { color: var(--success); }
  .stat-value.warning { color: var(--warning); }

  /* Section */
  .section {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    overflow: hidden;
  }
  .section-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 14px 20px;
    border-bottom: 1px solid var(--border);
  }
  .section-title {
    font-size: 13px;
    font-weight: 600;
    display: flex;
    align-items: center;
    gap: 8px;
  }
  .section-badge {
    background: var(--accent-glow);
    color: var(--accent);
    font-size: 11px;
    font-weight: 600;
    padding: 2px 8px;
    border-radius: 10px;
  }

  /* File list */
  .file-list {
    max-height: 200px;
    overflow-y: auto;
  }
  .file-item {
    display: flex;
    align-items: center;
    padding: 10px 20px;
    border-bottom: 1px solid var(--border);
    gap: 12px;
    transition: background 0.1s;
  }
  .file-item:last-child { border-bottom: none; }
  .file-item:hover { background: var(--surface-hover); }
  .file-num {
    font-size: 11px;
    color: var(--text-muted);
    min-width: 24px;
    text-align: center;
  }
  .file-icon { font-size: 16px; }
  .file-name {
    flex: 1;
    font-size: 13px;
    font-weight: 500;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
  }
  .file-size {
    font-size: 11px;
    color: var(--text-muted);
  }
  .file-status {
    font-size: 12px;
    padding: 2px 10px;
    border-radius: 10px;
    font-weight: 500;
  }
  .file-status.pending { background: var(--surface-hover); color: var(--text-muted); }
  .file-status.processing { background: var(--warning-bg); color: var(--warning); }
  .file-status.done { background: var(--success-bg); color: var(--success); }
  .file-status.error { background: var(--danger-bg); color: var(--danger); }
  .file-remove {
    background: none;
    border: none;
    color: var(--text-muted);
    cursor: pointer;
    font-size: 16px;
    padding: 2px 6px;
    border-radius: 4px;
    transition: all 0.1s;
  }
  .file-remove:hover { background: var(--danger-bg); color: var(--danger); }

  /* Results table */
  .table-wrap {
    overflow-x: auto;
    overflow-y: auto;
    max-height: 420px;
  }
  .table-wrap table {
    width: 100%;
    border-collapse: collapse;
    font-size: 12.5px;
    min-width: 1100px;
  }
  .table-wrap thead {
    position: sticky;
    top: 0;
    z-index: 2;
  }
  .table-wrap th {
    background: #1e2130;
    color: var(--text-dim);
    font-weight: 600;
    font-size: 11px;
    text-transform: uppercase;
    letter-spacing: 0.4px;
    padding: 10px 12px;
    text-align: left;
    white-space: nowrap;
    border-bottom: 2px solid var(--border);
  }
  .table-wrap td {
    padding: 9px 12px;
    border-bottom: 1px solid var(--border);
    white-space: nowrap;
    max-width: 200px;
    overflow: hidden;
    text-overflow: ellipsis;
  }
  .table-wrap tr:hover td { background: var(--surface-hover); }
  .table-wrap td.address { max-width: 280px; }
  .table-wrap .row-num {
    color: var(--text-muted);
    font-size: 11px;
    text-align: center;
    min-width: 30px;
  }
  .empty-state {
    padding: 50px 20px;
    text-align: center;
    color: var(--text-muted);
    font-size: 13px;
  }
  .empty-state .empty-icon {
    font-size: 36px;
    margin-bottom: 10px;
    opacity: 0.5;
  }

  /* Progress bar */
  .progress-bar {
    height: 3px;
    background: var(--border);
    border-radius: 2px;
    overflow: hidden;
    display: none;
  }
  .progress-bar.active { display: block; }
  .progress-fill {
    height: 100%;
    background: linear-gradient(90deg, var(--accent), #7c3aed);
    border-radius: 2px;
    transition: width 0.3s ease;
    width: 0%;
  }

  /* Log */
  .log-area {
    font-family: 'Consolas', 'Courier New', monospace;
    font-size: 11.5px;
    padding: 12px 16px;
    max-height: 120px;
    overflow-y: auto;
    line-height: 1.6;
    color: var(--text-dim);
  }
  .log-line { }
  .log-line.success { color: var(--success); }
  .log-line.error { color: var(--danger); }
  .log-line.info { color: var(--accent); }
  .log-time { color: var(--text-muted); margin-right: 6px; }

  /* Scrollbar */
  ::-webkit-scrollbar { width: 6px; height: 6px; }
  ::-webkit-scrollbar-track { background: transparent; }
  ::-webkit-scrollbar-thumb { background: var(--border); border-radius: 3px; }
  ::-webkit-scrollbar-thumb:hover { background: var(--text-muted); }

  /* Responsive */
  @media (max-width: 768px) {
    .header { padding: 14px 16px; }
    .main { padding: 16px; }
    .header h1 span { display: none; }
  }
</style>
</head>
<body>

<!-- Header -->
<div class="header">
  <div class="header-left">
    <div class="header-icon">ğŸ“„</div>
    <h1>ì œíœ´ì  ê³„ì•½ì„œ ì¶”ì¶œê¸°<span>ì‹ê¶ŒëŒ€ì¥ PDF â†’ Excel ë³€í™˜</span></h1>
  </div>
  <div class="header-actions">
    <button class="btn" onclick="clearAll()">
      <span class="btn-icon">ğŸ—‘ï¸</span> ì´ˆê¸°í™”
    </button>
    <button class="btn btn-primary" id="btnExtract" onclick="extractAll()" disabled>
      <span class="btn-icon">âš¡</span> ì „ì²´ ì¶”ì¶œ
    </button>
    <button class="btn btn-success" id="btnDownload" onclick="downloadExcel()" disabled>
      <span class="btn-icon">ğŸ“¥</span> ì—‘ì…€ ë‹¤ìš´ë¡œë“œ
    </button>
  </div>
</div>

<div class="main">
  <!-- Drop Zone -->
  <div class="drop-zone" id="dropZone">
    <div class="drop-icon">ğŸ“</div>
    <div class="drop-text">PDF íŒŒì¼ì„ ë“œë˜ê·¸í•˜ê±°ë‚˜ í´ë¦­í•˜ì—¬ ì„ íƒí•˜ì„¸ìš”</div>
    <div class="drop-hint">ì—¬ëŸ¬ íŒŒì¼ ë™ì‹œ ì„ íƒ ê°€ëŠ¥ Â· ì œíœ´ì  ì„œë¹„ìŠ¤ê³µê¸‰ ê³„ì•½ì„œ PDF</div>
    <input type="file" id="fileInput" accept=".pdf" multiple>
  </div>

  <!-- Stats -->
  <div class="stats-bar">
    <div class="stat-card">
      <div class="stat-icon">ğŸ“„</div>
      <div class="stat-info">
        <div class="stat-label">ë“±ë¡ íŒŒì¼</div>
        <div class="stat-value" id="statTotal">0</div>
      </div>
    </div>
    <div class="stat-card">
      <div class="stat-icon">âœ…</div>
      <div class="stat-info">
        <div class="stat-label">ì¶”ì¶œ ì„±ê³µ</div>
        <div class="stat-value success" id="statSuccess">0</div>
      </div>
    </div>
    <div class="stat-card">
      <div class="stat-icon">âš ï¸</div>
      <div class="stat-info">
        <div class="stat-label">ì‹¤íŒ¨</div>
        <div class="stat-value warning" id="statFail">0</div>
      </div>
    </div>
  </div>

  <!-- File List -->
  <div class="section">
    <div class="section-header">
      <div class="section-title">
        ğŸ“‹ íŒŒì¼ ëª©ë¡
        <span class="section-badge" id="fileBadge">0</span>
      </div>
    </div>
    <div class="progress-bar" id="progressBar"><div class="progress-fill" id="progressFill"></div></div>
    <div class="file-list" id="fileList">
      <div class="empty-state">
        <div class="empty-icon">ğŸ“‚</div>
        PDF íŒŒì¼ì„ ì¶”ê°€í•˜ë©´ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤
      </div>
    </div>
  </div>

  <!-- Results Table -->
  <div class="section">
    <div class="section-header">
      <div class="section-title">
        ğŸ“Š ì¶”ì¶œ ê²°ê³¼
        <span class="section-badge" id="resultBadge">0</span>
      </div>
      <button class="btn" onclick="copyToClipboard()" id="btnCopy" style="display:none">
        <span class="btn-icon">ğŸ“‹</span> í´ë¦½ë³´ë“œ ë³µì‚¬
      </button>
    </div>
    <div class="table-wrap" id="tableWrap">
      <div class="empty-state" id="emptyResult">
        <div class="empty-icon">ğŸ“Š</div>
        ì¶”ì¶œ ê²°ê³¼ê°€ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤
      </div>
    </div>
  </div>

  <!-- Log -->
  <div class="section">
    <div class="section-header">
      <div class="section-title">ğŸ“ ë¡œê·¸</div>
      <button class="btn" onclick="clearLog()" style="font-size:11px; padding: 4px 10px;">ì§€ìš°ê¸°</button>
    </div>
    <div class="log-area" id="logArea"></div>
  </div>
</div>

<script>
  // PDF.js ì›Œì»¤ ì„¤ì •
  pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';

  // ìƒíƒœ
  let pdfFiles = [];       // {file, name, size, status}
  let extractedData = [];  // ì¶”ì¶œ ê²°ê³¼

  // ============================================================
  // íŒŒì¼ ì…ë ¥ & ë“œë˜ê·¸ì•¤ë“œë¡­
  // ============================================================
  const dropZone = document.getElementById('dropZone');
  const fileInput = document.getElementById('fileInput');

  fileInput.addEventListener('change', (e) => {
    addFiles(e.target.files);
    fileInput.value = '';
  });

  dropZone.addEventListener('dragover', (e) => {
    e.preventDefault();
    dropZone.classList.add('drag-over');
  });
  dropZone.addEventListener('dragleave', () => {
    dropZone.classList.remove('drag-over');
  });
  dropZone.addEventListener('drop', (e) => {
    e.preventDefault();
    dropZone.classList.remove('drag-over');
    const files = [...e.dataTransfer.files].filter(f => f.type === 'application/pdf' || f.name.toLowerCase().endsWith('.pdf'));
    addFiles(files);
  });

  function addFiles(files) {
    for (const file of files) {
      // ì¤‘ë³µ ì²´í¬ (ì´ë¦„+í¬ê¸°)
      const exists = pdfFiles.some(f => f.name === file.name && f.size === file.size);
      if (exists) continue;
      pdfFiles.push({ file, name: file.name, size: file.size, status: 'pending' });
    }
    renderFileList();
    updateStats();
    document.getElementById('btnExtract').disabled = pdfFiles.length === 0;
    log(`${files.length}ê°œ íŒŒì¼ ì¶”ê°€ë¨ (ì´ ${pdfFiles.length}ê°œ)`, 'info');
  }

  function removeFile(idx) {
    pdfFiles.splice(idx, 1);
    renderFileList();
    updateStats();
    document.getElementById('btnExtract').disabled = pdfFiles.length === 0;
  }

  function formatSize(bytes) {
    if (bytes < 1024) return bytes + ' B';
    if (bytes < 1048576) return (bytes / 1024).toFixed(1) + ' KB';
    return (bytes / 1048576).toFixed(1) + ' MB';
  }

  function renderFileList() {
    const list = document.getElementById('fileList');
    if (pdfFiles.length === 0) {
      list.innerHTML = '<div class="empty-state"><div class="empty-icon">ğŸ“‚</div>PDF íŒŒì¼ì„ ì¶”ê°€í•˜ë©´ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤</div>';
      document.getElementById('fileBadge').textContent = '0';
      return;
    }
    document.getElementById('fileBadge').textContent = pdfFiles.length;
    list.innerHTML = pdfFiles.map((f, i) => `
      <div class="file-item">
        <span class="file-num">${i + 1}</span>
        <span class="file-icon">ğŸ“„</span>
        <span class="file-name" title="${f.name}">${f.name}</span>
        <span class="file-size">${formatSize(f.size)}</span>
        <span class="file-status ${f.status}">${
          f.status === 'pending' ? 'ëŒ€ê¸°' :
          f.status === 'processing' ? 'ì²˜ë¦¬ì¤‘...' :
          f.status === 'done' ? 'ì™„ë£Œ âœ“' : 'ì‹¤íŒ¨ âœ—'
        }</span>
        <button class="file-remove" onclick="removeFile(${i})" title="ì œê±°">âœ•</button>
      </div>
    `).join('');
  }

  function updateStats() {
    document.getElementById('statTotal').textContent = pdfFiles.length;
    document.getElementById('statSuccess').textContent = extractedData.length;
    document.getElementById('statFail').textContent = pdfFiles.filter(f => f.status === 'error').length;
  }

  // ============================================================
  // PDF í…ìŠ¤íŠ¸ ì¶”ì¶œ (PDF.js)
  // ============================================================
  async function extractTextFromPDF(file) {
    const arrayBuffer = await file.arrayBuffer();
    const pdf = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;
    const numPages = pdf.numPages;

    // ë§ˆì§€ë§‰ í˜ì´ì§€ë¶€í„° ì—­ìˆœìœ¼ë¡œ í…ìŠ¤íŠ¸ ì¶”ì¶œ (ê³„ì•½ì •ë³´ëŠ” ë§ˆì§€ë§‰ í˜ì´ì§€)
    let targetText = '';

    // ë§ˆì§€ë§‰ í˜ì´ì§€ ë¨¼ì € ì‹œë„
    for (let p = numPages; p >= Math.max(1, numPages - 1); p--) {
      const page = await pdf.getPage(p);
      const content = await page.getTextContent();

      // í…ìŠ¤íŠ¸ ì•„ì´í…œì„ Yì¢Œí‘œë¡œ ê·¸ë£¹í•‘í•˜ì—¬ ì¤„ ë‹¨ìœ„ë¡œ ì¬êµ¬ì„±
      const items = content.items;
      if (items.length === 0) continue;

      // Yì¢Œí‘œ ê¸°ì¤€ ì¤„ ê·¸ë£¹í•‘
      const lines = {};
      for (const item of items) {
        const y = Math.round(item.transform[5]); // Yì¢Œí‘œ ë°˜ì˜¬ë¦¼
        if (!lines[y]) lines[y] = [];
        lines[y].push({ x: item.transform[4], text: item.str });
      }

      // Yì¢Œí‘œ ë‚´ë¦¼ì°¨ìˆœ ì •ë ¬ (ìœ„â†’ì•„ë˜), ê° ì¤„ ë‚´ Xì¢Œí‘œ ì˜¤ë¦„ì°¨ìˆœ
      const sortedYs = Object.keys(lines).sort((a, b) => b - a);
      let pageText = '';
      for (const y of sortedYs) {
        const lineItems = lines[y].sort((a, b) => a.x - b.x);
        const lineText = lineItems.map(it => it.text).join(' ');
        pageText += lineText + '\n';
      }

      // "ê³„ì•½ì²´ê²°ì¼"ì´ í¬í•¨ëœ í˜ì´ì§€ë©´ ì´ê±¸ ì‚¬ìš©
      if (pageText.includes('ê³„ì•½ì²´ê²°ì¼')) {
        targetText = pageText;
        break;
      }
      if (!targetText) targetText = pageText;
    }

    // ë§Œì•½ ë§ˆì§€ë§‰ 2í˜ì´ì§€ì—ì„œ ëª» ì°¾ìœ¼ë©´ ì „ì²´ì—ì„œ ì°¾ê¸°
    if (!targetText.includes('ê³„ì•½ì²´ê²°ì¼')) {
      for (let p = 1; p <= numPages; p++) {
        const page = await pdf.getPage(p);
        const content = await page.getTextContent();
        const text = content.items.map(i => i.str).join(' ');
        if (text.includes('ê³„ì•½ì²´ê²°ì¼')) {
          // ì´ í˜ì´ì§€ë¥¼ ë‹¤ì‹œ ì¤„ ë‹¨ìœ„ë¡œ ì¶”ì¶œ
          const items = content.items;
          const lines = {};
          for (const item of items) {
            const y = Math.round(item.transform[5]);
            if (!lines[y]) lines[y] = [];
            lines[y].push({ x: item.transform[4], text: item.str });
          }
          const sortedYs = Object.keys(lines).sort((a, b) => b - a);
          targetText = '';
          for (const y of sortedYs) {
            const lineItems = lines[y].sort((a, b) => a.x - b.x);
            targetText += lineItems.map(it => it.text).join(' ') + '\n';
          }
          break;
        }
      }
    }

    return targetText;
  }

  // ============================================================
  // ë°ì´í„° íŒŒì‹±
  // ============================================================
  function parseContractData(text) {
    const data = {};
    const t = text; // ì¤„ì„

    // 1. ê³„ì•½ì²´ê²°ì¼
    let m = t.match(/ê³„ì•½ì²´ê²°ì¼\s*(\d{4})\s*ë…„?\s*(\d{1,2})\s*ì›”?\s*(\d{1,2})\s*ì¼?/);
    if (m) {
      data.contractDate = `${m[1]}-${m[2].padStart(2,'0')}-${m[3].padStart(2,'0')}`;
    } else {
      data.contractDate = '';
    }

    // 2. ìƒí˜¸ & ëŒ€í‘œì (ê°™ì€ ì¤„ì— ìˆìŒ)
    // "ìƒ í˜¸  ê³ ìƒ…ë§Œë‘  ëŒ€í‘œì  ì „ìœ ì£¼"
    m = t.match(/ìƒ\s*í˜¸\s+(.+?)\s+ëŒ€í‘œì\s+(\S+)/);
    if (m) {
      data.storeName = m[1].trim();
      data.representative = m[2].trim();
    } else {
      data.storeName = '';
      data.representative = '';
    }

    // 3. ë§¤ì¥ì „í™”ë²ˆí˜¸ & íœ´ëŒ€ì „í™”ë²ˆí˜¸ (ê°™ì€ ì¤„)
    m = t.match(/ë§¤ì¥ì „í™”ë²ˆí˜¸\s+([\d\-]+)/);
    data.storePhone = m ? m[1] : '';

    m = t.match(/íœ´ëŒ€ì „í™”ë²ˆí˜¸\s+([\d\-]+)/);
    data.mobilePhone = m ? m[1] : '';

    // 4. ì£¼ì†Œ - ì œíœ´ì  ì£¼ì†Œ (ìš´ì˜íšŒì‚¬ ì£¼ì†Œ ì œì™¸)
    // íŒ¨í„´: "ì œíœ´ì  ì£¼ ì†Œ ..." ë˜ëŠ” "ì£¼ ì†Œ ..." (ê°•ë‚¨êµ¬/ì‚¼ì„±ë™ ì œì™¸)
    data.address = '';
    const addressMatches = [...t.matchAll(/ì£¼\s*ì†Œ\s+(.+)/g)];
    for (const am of addressMatches) {
      const addr = am[1].trim();
      // ìš´ì˜íšŒì‚¬ ì£¼ì†Œ ì œì™¸
      if (!addr.includes('ê°•ë‚¨êµ¬') && !addr.includes('ì‚¼ì„±ë™') && !addr.includes('ë´‰ì€ì‚¬ë¡œ') && addr.length > 3) {
        data.address = addr;
        break;
      }
    }

    // 5. ì´ë©”ì¼
    m = t.match(/ì´ë©”ì¼ì£¼ì†Œ\s+(\S+@\S+)/);
    if (m) {
      data.email = m[1];
    } else {
      m = t.match(/([\w.\-]+@[\w.\-]+\.\w+)/);
      data.email = m ? m[1] : '';
    }

    // 6. ìš´ì˜ì‹œê°„
    m = t.match(/ìš´ì˜ì‹œê°„\s+(\S+)/);
    data.operatingHours = m ? m[1] : '';

    // 7. ì€í–‰ëª…
    m = t.match(/ì€í–‰ëª…\s+(\S+)/);
    data.bankName = m ? m[1] : '';

    // 8. ê³„ì¢Œë²ˆí˜¸
    m = t.match(/ê³„ì¢Œë²ˆí˜¸\s+([\d\-]+)/);
    data.accountNumber = m ? m[1] : '';

    // 9. ëª…ì˜ì£¼
    m = t.match(/(?:ê³„ì¢Œ\s*)?ëª…ì˜ì£¼\s+(\S+)/);
    data.accountHolder = m ? m[1] : '';

    // 10. ì‚¬ì—…ìë²ˆí˜¸ (- ì œê±°)
    m = t.match(/ì‚¬ì—…ì\s*ë“±ë¡ë²ˆí˜¸\s+([\d\-]+)/);
    data.businessNumber = m ? m[1].replace(/-/g, '') : '';

    return data;
  }

  // ============================================================
  // ì „ì²´ ì¶”ì¶œ
  // ============================================================
  async function extractAll() {
    if (pdfFiles.length === 0) return;

    const btnExtract = document.getElementById('btnExtract');
    btnExtract.disabled = true;
    btnExtract.innerHTML = '<span class="btn-icon">â³</span> ì²˜ë¦¬ ì¤‘...';

    const progressBar = document.getElementById('progressBar');
    const progressFill = document.getElementById('progressFill');
    progressBar.classList.add('active');

    extractedData = [];
    const total = pdfFiles.length;

    log(`ì¶”ì¶œ ì‹œì‘ - ì´ ${total}ê°œ íŒŒì¼`, 'info');

    for (let i = 0; i < total; i++) {
      const pf = pdfFiles[i];
      pf.status = 'processing';
      renderFileList();
      progressFill.style.width = `${((i) / total) * 100}%`;

      try {
        log(`[${i + 1}/${total}] ì²˜ë¦¬ ì¤‘: ${pf.name}`);
        const text = await extractTextFromPDF(pf.file);
        const data = parseContractData(text);

        // ìµœì†Œí•œ ìƒí˜¸ê°€ ìˆì–´ì•¼ ì„±ê³µìœ¼ë¡œ íŒì •
        if (data.storeName || data.businessNumber) {
          data._fileName = pf.name;
          extractedData.push(data);
          pf.status = 'done';
          log(`  âœ“ ì¶”ì¶œ ì„±ê³µ: ${data.storeName || '(ìƒí˜¸ ì—†ìŒ)'}`, 'success');
        } else {
          pf.status = 'error';
          log(`  âœ— ë°ì´í„°ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŒ: ${pf.name}`, 'error');
        }
      } catch (err) {
        pf.status = 'error';
        log(`  âœ— ì˜¤ë¥˜: ${pf.name} - ${err.message}`, 'error');
      }

      renderFileList();
      progressFill.style.width = `${((i + 1) / total) * 100}%`;
    }

    renderResultTable();
    updateStats();

    const successCount = extractedData.length;
    const failCount = total - successCount;
    log(`ì¶”ì¶œ ì™„ë£Œ! ì„±ê³µ: ${successCount}ê°œ, ì‹¤íŒ¨: ${failCount}ê°œ`, successCount > 0 ? 'success' : 'error');

    btnExtract.disabled = false;
    btnExtract.innerHTML = '<span class="btn-icon">âš¡</span> ì „ì²´ ì¶”ì¶œ';
    document.getElementById('btnDownload').disabled = extractedData.length === 0;

    setTimeout(() => {
      progressBar.classList.remove('active');
    }, 1000);
  }

  // ============================================================
  // ê²°ê³¼ í…Œì´ë¸” ë Œë”ë§
  // ============================================================
  function renderResultTable() {
    const wrap = document.getElementById('tableWrap');
    const badge = document.getElementById('resultBadge');
    const btnCopy = document.getElementById('btnCopy');

    badge.textContent = extractedData.length;

    if (extractedData.length === 0) {
      wrap.innerHTML = '<div class="empty-state"><div class="empty-icon">ğŸ“Š</div>ì¶”ì¶œ ê²°ê³¼ê°€ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤</div>';
      btnCopy.style.display = 'none';
      return;
    }

    btnCopy.style.display = '';

    const headers = ['#', 'ì²´ê²°ì¼', 'ìƒí˜¸', 'ëŒ€í‘œì', 'ë§¤ì¥ì „í™”', 'íœ´ëŒ€ì „í™”', 'ì£¼ì†Œ', 'ì´ë©”ì¼', 'ìš´ì˜ì‹œê°„', 'ì€í–‰ëª…', 'ê³„ì¢Œë²ˆí˜¸', 'ëª…ì˜ì£¼', 'ì‚¬ì—…ìë²ˆí˜¸'];
    const keys = ['contractDate', 'storeName', 'representative', 'storePhone', 'mobilePhone', 'address', 'email', 'operatingHours', 'bankName', 'accountNumber', 'accountHolder', 'businessNumber'];

    let html = '<table><thead><tr>';
    headers.forEach(h => { html += `<th>${h}</th>`; });
    html += '</tr></thead><tbody>';

    extractedData.forEach((d, i) => {
      html += '<tr>';
      html += `<td class="row-num">${i + 1}</td>`;
      keys.forEach(k => {
        const cls = k === 'address' ? ' class="address"' : '';
        html += `<td${cls} title="${(d[k]||'').replace(/"/g,'&quot;')}">${d[k] || '-'}</td>`;
      });
      html += '</tr>';
    });

    html += '</tbody></table>';
    wrap.innerHTML = html;
  }

  // ============================================================
  // ì—‘ì…€ ë‹¤ìš´ë¡œë“œ (SheetJS)
  // ============================================================
  function downloadExcel() {
    if (extractedData.length === 0) return;

    const headers = ['ì²´ê²°ì¼', 'ìƒí˜¸', 'ëŒ€í‘œì', 'ë§¤ì¥ì „í™”ë²ˆí˜¸', 'íœ´ëŒ€ì „í™”ë²ˆí˜¸', 'ì£¼ì†Œ', 'ì´ë©”ì¼', 'ìš´ì˜ì‹œê°„', 'ì€í–‰ëª…', 'ê³„ì¢Œë²ˆí˜¸', 'ëª…ì˜ì£¼', 'ì‚¬ì—…ìë²ˆí˜¸'];
    const keys = ['contractDate', 'storeName', 'representative', 'storePhone', 'mobilePhone', 'address', 'email', 'operatingHours', 'bankName', 'accountNumber', 'accountHolder', 'businessNumber'];

    const wsData = [headers];
    extractedData.forEach(d => {
      wsData.push(keys.map(k => d[k] || ''));
    });

    const wb = XLSX.utils.book_new();
    const ws = XLSX.utils.aoa_to_sheet(wsData);

    // ì—´ ë„ˆë¹„ ì„¤ì •
    ws['!cols'] = [
      { wch: 12 }, // ì²´ê²°ì¼
      { wch: 15 }, // ìƒí˜¸
      { wch: 8 },  // ëŒ€í‘œì
      { wch: 14 }, // ë§¤ì¥ì „í™”
      { wch: 14 }, // íœ´ëŒ€ì „í™”
      { wch: 35 }, // ì£¼ì†Œ
      { wch: 25 }, // ì´ë©”ì¼
      { wch: 14 }, // ìš´ì˜ì‹œê°„
      { wch: 12 }, // ì€í–‰ëª…
      { wch: 18 }, // ê³„ì¢Œë²ˆí˜¸
      { wch: 8 },  // ëª…ì˜ì£¼
      { wch: 14 }, // ì‚¬ì—…ìë²ˆí˜¸
    ];

    XLSX.utils.book_append_sheet(wb, ws, 'ì œíœ´ì  ê³„ì•½ ë°ì´í„°');

    const now = new Date();
    const dateStr = `${now.getFullYear()}${String(now.getMonth()+1).padStart(2,'0')}${String(now.getDate()).padStart(2,'0')}`;
    XLSX.writeFile(wb, `ì œíœ´ì _ê³„ì•½ì¶”ì¶œ_${dateStr}.xlsx`);

    log('ì—‘ì…€ íŒŒì¼ ë‹¤ìš´ë¡œë“œ ì™„ë£Œ', 'success');
  }

  // ============================================================
  // í´ë¦½ë³´ë“œ ë³µì‚¬ (íƒ­ êµ¬ë¶„)
  // ============================================================
  function copyToClipboard() {
    if (extractedData.length === 0) return;

    const headers = ['ì²´ê²°ì¼', 'ìƒí˜¸', 'ëŒ€í‘œì', 'ë§¤ì¥ì „í™”ë²ˆí˜¸', 'íœ´ëŒ€ì „í™”ë²ˆí˜¸', 'ì£¼ì†Œ', 'ì´ë©”ì¼', 'ìš´ì˜ì‹œê°„', 'ì€í–‰ëª…', 'ê³„ì¢Œë²ˆí˜¸', 'ëª…ì˜ì£¼', 'ì‚¬ì—…ìë²ˆí˜¸'];
    const keys = ['contractDate', 'storeName', 'representative', 'storePhone', 'mobilePhone', 'address', 'email', 'operatingHours', 'bankName', 'accountNumber', 'accountHolder', 'businessNumber'];

    let tsv = headers.join('\t') + '\n';
    extractedData.forEach(d => {
      tsv += keys.map(k => d[k] || '').join('\t') + '\n';
    });

    navigator.clipboard.writeText(tsv).then(() => {
      log('í´ë¦½ë³´ë“œì— ë³µì‚¬ ì™„ë£Œ (íƒ­ êµ¬ë¶„ - ì—‘ì…€ì— ë°”ë¡œ ë¶™ì—¬ë„£ê¸° ê°€ëŠ¥)', 'success');
      // ë²„íŠ¼ í”¼ë“œë°±
      const btn = document.getElementById('btnCopy');
      const orig = btn.innerHTML;
      btn.innerHTML = '<span class="btn-icon">âœ…</span> ë³µì‚¬ë¨!';
      setTimeout(() => { btn.innerHTML = orig; }, 1500);
    });
  }

  // ============================================================
  // ì´ˆê¸°í™”
  // ============================================================
  function clearAll() {
    pdfFiles = [];
    extractedData = [];
    renderFileList();
    renderResultTable();
    updateStats();
    document.getElementById('btnExtract').disabled = true;
    document.getElementById('btnDownload').disabled = true;
    log('ì´ˆê¸°í™” ì™„ë£Œ', 'info');
  }

  // ============================================================
  // ë¡œê·¸
  // ============================================================
  function log(msg, type = '') {
    const area = document.getElementById('logArea');
    const now = new Date();
    const time = `${String(now.getHours()).padStart(2,'0')}:${String(now.getMinutes()).padStart(2,'0')}:${String(now.getSeconds()).padStart(2,'0')}`;
    const line = document.createElement('div');
    line.className = `log-line ${type}`;
    line.innerHTML = `<span class="log-time">[${time}]</span>${msg}`;
    area.insertBefore(line, area.firstChild);
    // ë¡œê·¸ 100ì¤„ ì œí•œ
    while (area.children.length > 100) area.removeChild(area.lastChild);
  }

  function clearLog() {
    document.getElementById('logArea').innerHTML = '';
  }

  // ì´ˆê¸° ë¡œê·¸
  log('PDF ì œíœ´ì  ê³„ì•½ì„œ ì¶”ì¶œê¸° ì¤€ë¹„ ì™„ë£Œ', 'info');
</script>
</body>
</html>
