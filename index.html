<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ì œíœ´ì  ê³„ì•½ì„œ ë°ì´í„° ì¶”ì¶œê¸°</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<style>
  @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;600;700&display=swap');

  * { margin: 0; padding: 0; box-sizing: border-box; }

  :root {
    --bg: #f5f6fa;
    --surface: #ffffff;
    --surface-hover: #f8f9fc;
    --border: #e2e5ed;
    --border-active: #3b6cf7;
    --text: #1e2634;
    --text-dim: #5a6474;
    --text-muted: #98a1b0;
    --accent: #3b6cf7;
    --accent-light: #eef2ff;
    --accent-hover: #2c59e0;
    --success: #0ea55a;
    --success-bg: #edfaf3;
    --warning: #e5960b;
    --warning-bg: #fef8ec;
    --danger: #e5453d;
    --danger-bg: #fef0ef;
    --radius: 8px;
    --radius-sm: 6px;
    --shadow-sm: 0 1px 3px rgba(0,0,0,0.06);
    --shadow: 0 2px 8px rgba(0,0,0,0.08);
  }

  body {
    font-family: 'Noto Sans KR', -apple-system, BlinkMacSystemFont, sans-serif;
    background: var(--bg);
    color: var(--text);
    min-height: 100vh;
    line-height: 1.5;
  }

  /* Header */
  .header {
    background: var(--surface);
    border-bottom: 1px solid var(--border);
    padding: 16px 32px;
    display: flex;
    align-items: center;
    justify-content: space-between;
    position: sticky;
    top: 0;
    z-index: 100;
    box-shadow: var(--shadow-sm);
  }
  .header-left { display: flex; align-items: center; gap: 12px; }
  .header-icon {
    width: 34px; height: 34px;
    background: var(--accent);
    border-radius: var(--radius-sm);
    display: flex; align-items: center; justify-content: center;
    font-size: 16px;
    color: #fff;
  }
  .header h1 { font-size: 16px; font-weight: 600; color: var(--text); }
  .header h1 span { color: var(--text-muted); font-weight: 400; font-size: 12.5px; margin-left: 10px; }
  .header-actions { display: flex; gap: 8px; }

  /* Buttons */
  .btn {
    display: inline-flex; align-items: center; gap: 6px;
    padding: 8px 16px;
    border: 1px solid var(--border); border-radius: var(--radius-sm);
    background: var(--surface); color: var(--text);
    font-family: inherit; font-size: 13px; font-weight: 500;
    cursor: pointer; transition: all 0.15s ease; white-space: nowrap;
  }
  .btn:hover { background: var(--surface-hover); border-color: #ccd1dc; }
  .btn-primary { background: var(--accent); border-color: var(--accent); color: #fff; }
  .btn-primary:hover { background: var(--accent-hover); border-color: var(--accent-hover); }
  .btn-primary:disabled { opacity: 0.45; cursor: not-allowed; background: var(--accent); }
  .btn-success { background: var(--success); border-color: var(--success); color: #fff; font-weight: 600; }
  .btn-success:hover { background: #0c9450; }
  .btn-success:disabled { opacity: 0.45; cursor: not-allowed; }
  .btn-icon { font-size: 14px; line-height: 1; }

  /* Main */
  .main {
    max-width: 1400px;
    margin: 0 auto;
    padding: 24px 32px;
    display: flex; flex-direction: column; gap: 18px;
  }

  /* Drop Zone */
  .drop-zone {
    border: 2px dashed var(--border);
    border-radius: var(--radius);
    padding: 44px 24px;
    text-align: center;
    transition: all 0.2s ease;
    cursor: pointer;
    position: relative;
    background: var(--surface);
  }
  .drop-zone:hover { border-color: var(--accent); background: var(--accent-light); }
  .drop-zone.drag-over { border-color: var(--accent); background: var(--accent-light); transform: scale(1.003); }
  .drop-icon { font-size: 36px; margin-bottom: 10px; }
  .drop-text { font-size: 14px; font-weight: 500; color: var(--text); margin-bottom: 4px; }
  .drop-hint { font-size: 12px; color: var(--text-muted); }
  .drop-zone input[type="file"] { position: absolute; inset: 0; opacity: 0; cursor: pointer; }

  /* Stats */
  .stats-bar { display: flex; gap: 12px; flex-wrap: wrap; }
  .stat-card {
    background: var(--surface); border: 1px solid var(--border);
    border-radius: var(--radius); padding: 14px 20px;
    flex: 1; min-width: 140px;
    display: flex; align-items: center; gap: 12px;
    box-shadow: var(--shadow-sm);
  }
  .stat-icon { font-size: 20px; }
  .stat-info { display: flex; flex-direction: column; }
  .stat-label { font-size: 11px; color: var(--text-muted); font-weight: 500; letter-spacing: 0.3px; }
  .stat-value { font-size: 22px; font-weight: 700; color: var(--text); }
  .stat-value.success { color: var(--success); }
  .stat-value.warning { color: var(--warning); }

  /* Section */
  .section {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    overflow: hidden;
    box-shadow: var(--shadow-sm);
  }
  .section-header {
    display: flex; align-items: center; justify-content: space-between;
    padding: 12px 18px;
    border-bottom: 1px solid var(--border);
    background: #fafbfd;
  }
  .section-title { font-size: 13px; font-weight: 600; color: var(--text); display: flex; align-items: center; gap: 8px; }
  .section-badge {
    background: var(--accent-light); color: var(--accent);
    font-size: 11px; font-weight: 600; padding: 2px 8px; border-radius: 10px;
  }

  /* File list */
  .file-list { max-height: 200px; overflow-y: auto; }
  .file-item {
    display: flex; align-items: center; padding: 10px 18px;
    border-bottom: 1px solid #f0f1f5; gap: 12px; transition: background 0.1s;
  }
  .file-item:last-child { border-bottom: none; }
  .file-item:hover { background: #f8f9fc; }
  .file-num { font-size: 11px; color: var(--text-muted); min-width: 22px; text-align: center; }
  .file-icon { font-size: 15px; }
  .file-name { flex: 1; font-size: 13px; font-weight: 500; color: var(--text); overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
  .file-size { font-size: 11px; color: var(--text-muted); }
  .file-status { font-size: 11.5px; padding: 2px 10px; border-radius: 10px; font-weight: 500; }
  .file-status.pending { background: #f0f1f5; color: var(--text-muted); }
  .file-status.processing { background: var(--warning-bg); color: var(--warning); }
  .file-status.done { background: var(--success-bg); color: var(--success); }
  .file-status.error { background: var(--danger-bg); color: var(--danger); }
  .file-remove {
    background: none; border: none; color: var(--text-muted);
    cursor: pointer; font-size: 15px; padding: 2px 6px;
    border-radius: 4px; transition: all 0.1s;
  }
  .file-remove:hover { background: var(--danger-bg); color: var(--danger); }

  /* Results table */
  .table-wrap { overflow-x: auto; overflow-y: auto; max-height: 420px; }
  .table-wrap table { width: 100%; border-collapse: collapse; font-size: 12.5px; min-width: 1100px; }
  .table-wrap thead { position: sticky; top: 0; z-index: 2; }
  .table-wrap th {
    background: #f5f6fa; color: var(--text-dim);
    font-weight: 600; font-size: 11px;
    letter-spacing: 0.3px; padding: 10px 12px; text-align: left;
    white-space: nowrap; border-bottom: 2px solid var(--border);
  }
  .table-wrap td {
    padding: 9px 12px; border-bottom: 1px solid #f0f1f5;
    white-space: nowrap; max-width: 200px; overflow: hidden; text-overflow: ellipsis;
    color: var(--text);
  }
  .table-wrap tr:hover td { background: #f8f9fc; }
  .table-wrap td.address { max-width: 280px; }
  .table-wrap .row-num { color: var(--text-muted); font-size: 11px; text-align: center; min-width: 30px; }
  .empty-state { padding: 50px 20px; text-align: center; color: var(--text-muted); font-size: 13px; }
  .empty-state .empty-icon { font-size: 32px; margin-bottom: 8px; opacity: 0.5; }

  /* Progress */
  .progress-bar { height: 3px; background: #eceef3; border-radius: 2px; overflow: hidden; display: none; }
  .progress-bar.active { display: block; }
  .progress-fill { height: 100%; background: linear-gradient(90deg, var(--accent), #6e8efb); border-radius: 2px; transition: width 0.3s ease; width: 0%; }

  /* Log */
  .log-area {
    font-family: 'Consolas', 'SF Mono', 'Courier New', monospace;
    font-size: 11.5px; padding: 12px 16px;
    max-height: 120px; overflow-y: auto; line-height: 1.65; color: var(--text-dim);
    background: #fafbfd;
  }
  .log-line.success { color: var(--success); }
  .log-line.error { color: var(--danger); }
  .log-line.info { color: var(--accent); }
  .log-time { color: var(--text-muted); margin-right: 6px; }

  .debug-toggle { font-size: 11px; padding: 4px 10px; }
  .debug-area {
    display: none; padding: 12px 16px; max-height: 200px; overflow-y: auto;
    font-family: 'Consolas', monospace; font-size: 11px; line-height: 1.5;
    color: var(--text-dim); white-space: pre-wrap; word-break: break-all;
    background: #f5f6fa; border-bottom: 1px solid var(--border);
  }
  .debug-area.visible { display: block; }

  ::-webkit-scrollbar { width: 5px; height: 5px; }
  ::-webkit-scrollbar-track { background: transparent; }
  ::-webkit-scrollbar-thumb { background: #d4d7e0; border-radius: 3px; }
  ::-webkit-scrollbar-thumb:hover { background: #b8bcc8; }

  @media (max-width: 768px) {
    .header { padding: 12px 16px; }
    .main { padding: 16px; }
    .header h1 span { display: none; }
  }
</style>
</head>
<body>

<div class="header">
  <div class="header-left">
    <div class="header-icon">ğŸ“„</div>
    <h1>ì œíœ´ì  ê³„ì•½ì„œ ì¶”ì¶œê¸°<span>ì‹ê¶ŒëŒ€ì¥ PDF â†’ Excel ë³€í™˜</span></h1>
  </div>
  <div class="header-actions">
    <button class="btn" onclick="clearAll()"><span class="btn-icon">ğŸ—‘ï¸</span> ì´ˆê¸°í™”</button>
    <button class="btn btn-primary" id="btnExtract" onclick="extractAll()" disabled><span class="btn-icon">âš¡</span> ì „ì²´ ì¶”ì¶œ</button>
    <button class="btn btn-success" id="btnDownload" onclick="downloadExcel()" disabled><span class="btn-icon">ğŸ“¥</span> ì—‘ì…€ ë‹¤ìš´ë¡œë“œ</button>
  </div>
</div>

<div class="main">
  <div class="drop-zone" id="dropZone">
    <div class="drop-icon">ğŸ“</div>
    <div class="drop-text">PDF íŒŒì¼ì„ ë“œë˜ê·¸í•˜ê±°ë‚˜ í´ë¦­í•˜ì—¬ ì„ íƒí•˜ì„¸ìš”</div>
    <div class="drop-hint">ì—¬ëŸ¬ íŒŒì¼ ë™ì‹œ ì„ íƒ ê°€ëŠ¥ Â· ì œíœ´ì  ì„œë¹„ìŠ¤ê³µê¸‰ ê³„ì•½ì„œ PDF</div>
    <input type="file" id="fileInput" accept=".pdf" multiple>
  </div>

  <div class="stats-bar">
    <div class="stat-card">
      <div class="stat-icon">ğŸ“„</div>
      <div class="stat-info"><div class="stat-label">ë“±ë¡ íŒŒì¼</div><div class="stat-value" id="statTotal">0</div></div>
    </div>
    <div class="stat-card">
      <div class="stat-icon">âœ…</div>
      <div class="stat-info"><div class="stat-label">ì¶”ì¶œ ì„±ê³µ</div><div class="stat-value success" id="statSuccess">0</div></div>
    </div>
    <div class="stat-card">
      <div class="stat-icon">âš ï¸</div>
      <div class="stat-info"><div class="stat-label">ì‹¤íŒ¨</div><div class="stat-value warning" id="statFail">0</div></div>
    </div>
  </div>

  <div class="section">
    <div class="section-header">
      <div class="section-title">ğŸ“‹ íŒŒì¼ ëª©ë¡ <span class="section-badge" id="fileBadge">0</span></div>
    </div>
    <div class="progress-bar" id="progressBar"><div class="progress-fill" id="progressFill"></div></div>
    <div class="file-list" id="fileList">
      <div class="empty-state"><div class="empty-icon">ğŸ“‚</div>PDF íŒŒì¼ì„ ì¶”ê°€í•˜ë©´ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤</div>
    </div>
  </div>

  <div class="section">
    <div class="section-header">
      <div class="section-title">ğŸ“Š ì¶”ì¶œ ê²°ê³¼ <span class="section-badge" id="resultBadge">0</span></div>
      <div style="display:flex;gap:8px;">
        <button class="btn" onclick="copyToClipboard()" id="btnCopy" style="display:none"><span class="btn-icon">ğŸ“‹</span> í´ë¦½ë³´ë“œ ë³µì‚¬</button>
      </div>
    </div>
    <div class="table-wrap" id="tableWrap">
      <div class="empty-state" id="emptyResult"><div class="empty-icon">ğŸ“Š</div>ì¶”ì¶œ ê²°ê³¼ê°€ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤</div>
    </div>
  </div>

  <div class="section">
    <div class="section-header">
      <div class="section-title">ğŸ“ ë¡œê·¸</div>
      <div style="display:flex;gap:8px;">
        <button class="btn debug-toggle" onclick="toggleDebug()">Raw í…ìŠ¤íŠ¸</button>
        <button class="btn" onclick="clearLog()" style="font-size:11px; padding: 4px 10px;">ì§€ìš°ê¸°</button>
      </div>
    </div>
    <div class="debug-area" id="debugArea"></div>
    <div class="log-area" id="logArea"></div>
  </div>
</div>

<script>
  pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';

  let pdfFiles = [];
  let extractedData = [];
  let lastRawText = '';

  const dropZone = document.getElementById('dropZone');
  const fileInput = document.getElementById('fileInput');

  fileInput.addEventListener('change', (e) => { addFiles(e.target.files); fileInput.value = ''; });
  dropZone.addEventListener('dragover', (e) => { e.preventDefault(); dropZone.classList.add('drag-over'); });
  dropZone.addEventListener('dragleave', () => { dropZone.classList.remove('drag-over'); });
  dropZone.addEventListener('drop', (e) => {
    e.preventDefault(); dropZone.classList.remove('drag-over');
    addFiles([...e.dataTransfer.files].filter(f => f.type === 'application/pdf' || f.name.toLowerCase().endsWith('.pdf')));
  });

  function addFiles(files) {
    for (const file of files) {
      if (pdfFiles.some(f => f.name === file.name && f.size === file.size)) continue;
      pdfFiles.push({ file, name: file.name, size: file.size, status: 'pending' });
    }
    renderFileList(); updateStats();
    document.getElementById('btnExtract').disabled = pdfFiles.length === 0;
    log(`${files.length}ê°œ íŒŒì¼ ì¶”ê°€ë¨ (ì´ ${pdfFiles.length}ê°œ)`, 'info');
  }

  function removeFile(idx) {
    pdfFiles.splice(idx, 1); renderFileList(); updateStats();
    document.getElementById('btnExtract').disabled = pdfFiles.length === 0;
  }

  function formatSize(bytes) {
    if (bytes < 1024) return bytes + ' B';
    if (bytes < 1048576) return (bytes / 1024).toFixed(1) + ' KB';
    return (bytes / 1048576).toFixed(1) + ' MB';
  }

  function renderFileList() {
    const list = document.getElementById('fileList');
    document.getElementById('fileBadge').textContent = pdfFiles.length;
    if (pdfFiles.length === 0) {
      list.innerHTML = '<div class="empty-state"><div class="empty-icon">ğŸ“‚</div>PDF íŒŒì¼ì„ ì¶”ê°€í•˜ë©´ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤</div>';
      return;
    }
    list.innerHTML = pdfFiles.map((f, i) => `
      <div class="file-item">
        <span class="file-num">${i + 1}</span>
        <span class="file-icon">ğŸ“„</span>
        <span class="file-name" title="${f.name}">${f.name}</span>
        <span class="file-size">${formatSize(f.size)}</span>
        <span class="file-status ${f.status}">${
          f.status === 'pending' ? 'ëŒ€ê¸°' : f.status === 'processing' ? 'ì²˜ë¦¬ì¤‘...' :
          f.status === 'done' ? 'ì™„ë£Œ âœ“' : 'ì‹¤íŒ¨ âœ—'
        }</span>
        <button class="file-remove" onclick="removeFile(${i})" title="ì œê±°">âœ•</button>
      </div>
    `).join('');
  }

  function updateStats() {
    document.getElementById('statTotal').textContent = pdfFiles.length;
    document.getElementById('statSuccess').textContent = extractedData.length;
    document.getElementById('statFail').textContent = pdfFiles.filter(f => f.status === 'error').length;
  }

  // ============================================================
  // PDF í…ìŠ¤íŠ¸ ì¶”ì¶œ (PDF.js) - Yì¢Œí‘œ ê·¸ë£¹í•‘ + Xê°„ê²© ê³µë°± ì‚½ì…
  // ============================================================
  async function extractTextFromPDF(file) {
    const arrayBuffer = await file.arrayBuffer();
    const pdf = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;
    const numPages = pdf.numPages;

    let targetPage = null;
    for (let p = numPages; p >= 1; p--) {
      const page = await pdf.getPage(p);
      const content = await page.getTextContent();
      const rawText = content.items.map(it => it.str).join('');
      if (rawText.includes('ê³„ì•½ì²´ê²°ì¼') && rawText.includes('ì€í–‰ëª…')) {
        targetPage = page;
        break;
      }
    }
    if (!targetPage) targetPage = await pdf.getPage(numPages);

    const content = await targetPage.getTextContent();
    const items = content.items;
    if (items.length === 0) return '';

    const allItems = [];
    for (const item of items) {
      if (!item.str || item.str.trim() === '') continue;
      allItems.push({ x: item.transform[4], y: item.transform[5], w: item.width || 0, text: item.str });
    }

    allItems.sort((a, b) => b.y - a.y || a.x - b.x);

    const lines = [];
    let currentLine = [allItems[0]];
    let currentY = allItems[0].y;

    for (let i = 1; i < allItems.length; i++) {
      const item = allItems[i];
      if (Math.abs(item.y - currentY) <= 3) {
        currentLine.push(item);
      } else {
        lines.push([...currentLine]);
        currentLine = [item];
        currentY = item.y;
      }
    }
    lines.push(currentLine);

    const reconstructedLines = [];
    for (const line of lines) {
      line.sort((a, b) => a.x - b.x);
      let lineText = '';
      for (let i = 0; i < line.length; i++) {
        if (i === 0) { lineText = line[i].text; continue; }
        const prevEnd = line[i - 1].x + line[i - 1].w;
        const gap = line[i].x - prevEnd;
        lineText += (gap > 3 ? ' ' : '') + line[i].text;
      }
      reconstructedLines.push(lineText.trim());
    }
    return reconstructedLines.join('\n');
  }

  // ============================================================
  // ë°ì´í„° íŒŒì‹±
  // ============================================================
  function parseContractData(text) {
    const data = {};
    const lines = text.split('\n').map(l => l.trim()).filter(l => l);
    lastRawText = text;

    function findLine(kw) { return lines.find(l => l.includes(kw)) || ''; }
    function findLines(kw) { return lines.filter(l => l.includes(kw)); }

    // 1. ê³„ì•½ì²´ê²°ì¼
    const dateLine = findLine('ê³„ì•½ì²´ê²°ì¼');
    let m = dateLine.match(/(\d{4})\s*ë…„?\s*(\d{1,2})\s*ì›”?\s*(\d{1,2})\s*ì¼?/);
    if (!m) m = text.match(/ê³„ì•½ì²´ê²°ì¼[^\n]*?(\d{4})\s*ë…„?[\s\S]*?(\d{1,2})\s*ì›”?\s*(\d{1,2})\s*ì¼?/);
    data.contractDate = m ? `${m[1]}-${m[2].padStart(2,'0')}-${m[3].padStart(2,'0')}` : '';

    // 2. ìƒí˜¸ & ëŒ€í‘œì
    const storeLine = findLine('ìƒ í˜¸') || findLine('ìƒí˜¸');
    m = storeLine.match(/ìƒ\s*í˜¸\s+(.+?)\s+ëŒ€í‘œì\s+(\S+)/);
    if (m) {
      data.storeName = m[1].trim();
      data.representative = m[2].trim();
    } else {
      data.storeName = ''; data.representative = '';
      if (storeLine) {
        let cleaned = storeLine.replace(/ìƒ\s*í˜¸/, '').trim();
        const repIdx = cleaned.indexOf('ëŒ€í‘œì');
        if (repIdx >= 0) {
          data.storeName = cleaned.substring(0, repIdx).trim();
          data.representative = cleaned.substring(repIdx + 3).trim();
        } else { data.storeName = cleaned; }
      }
      if (!data.representative) {
        for (const l of findLines('ëŒ€í‘œì')) {
          m = l.match(/ëŒ€í‘œì\s+(\S+)/);
          if (m && m[1] !== 'ì¡°ì •í˜¸') { data.representative = m[1]; break; }
        }
      }
    }

    // 3. ë§¤ì¥ì „í™”
    const phoneLine = findLine('ë§¤ì¥ì „í™”ë²ˆí˜¸');
    m = phoneLine.match(/ë§¤ì¥ì „í™”ë²ˆí˜¸\s+([\d\-]+)/);
    data.storePhone = m ? m[1] : '';

    // 4. íœ´ëŒ€ì „í™”
    m = (phoneLine || text).match(/íœ´ëŒ€ì „í™”ë²ˆí˜¸\s+([\d\-]+)/);
    data.mobilePhone = m ? m[1] : '';

    // 5. ì£¼ì†Œ
    data.address = '';
    for (const l of findLines('ì£¼ ì†Œ').concat(findLines('ì£¼ì†Œ'))) {
      const am = l.match(/ì£¼\s*ì†Œ\s+(.+)/);
      if (am) {
        const addr = am[1].trim();
        if (!addr.includes('ê°•ë‚¨êµ¬') && !addr.includes('ì‚¼ì„±ë™') && !addr.includes('ë´‰ì€ì‚¬ë¡œ') && addr.length > 5) {
          data.address = addr; break;
        }
      }
    }

    // 6. ì´ë©”ì¼
    const emailLine = findLine('ì´ë©”ì¼');
    m = emailLine.match(/ì´ë©”ì¼ì£¼ì†Œ?\s+(\S+@\S+)/);
    if (!m) m = text.match(/([\w.\-]+@[\w.\-]+\.\w+)/);
    data.email = m ? m[1] : '';

    // 7. ìš´ì˜ì‹œê°„
    m = findLine('ìš´ì˜ì‹œê°„').match(/ìš´ì˜ì‹œê°„\s+(\S+)/);
    data.operatingHours = m ? m[1] : '';

    // 8. ì€í–‰ëª…
    m = findLine('ì€í–‰ëª…').match(/ì€í–‰ëª…\s+(\S+)/);
    data.bankName = m ? m[1] : '';

    // 9. ê³„ì¢Œë²ˆí˜¸
    m = findLine('ê³„ì¢Œë²ˆí˜¸').match(/ê³„ì¢Œë²ˆí˜¸\s+([\d\-]+)/);
    data.accountNumber = m ? m[1] : '';

    // 10. ëª…ì˜ì£¼
    m = findLine('ëª…ì˜ì£¼').match(/ëª…ì˜ì£¼\s+(\S+)/);
    data.accountHolder = m ? m[1] : '';

    // 11. ì‚¬ì—…ìë²ˆí˜¸
    m = findLine('ì‚¬ì—…ì').match(/ì‚¬ì—…ì\s*ë“±ë¡ë²ˆí˜¸\s+([\d\-]+)/);
    data.businessNumber = m ? m[1].replace(/-/g, '') : '';

    const fields = ['contractDate','storeName','representative','storePhone','mobilePhone','address','email','operatingHours','bankName','accountNumber','accountHolder','businessNumber'];
    const missing = fields.filter(f => !data[f]);
    if (missing.length > 0) log(`  âš  ëˆ„ë½: ${missing.join(', ')}`, 'error');

    return data;
  }

  // ============================================================
  // ì „ì²´ ì¶”ì¶œ
  // ============================================================
  async function extractAll() {
    if (pdfFiles.length === 0) return;
    const btn = document.getElementById('btnExtract');
    btn.disabled = true; btn.innerHTML = '<span class="btn-icon">â³</span> ì²˜ë¦¬ ì¤‘...';
    const pBar = document.getElementById('progressBar');
    const pFill = document.getElementById('progressFill');
    pBar.classList.add('active');
    extractedData = [];
    const total = pdfFiles.length;
    log(`ì¶”ì¶œ ì‹œì‘ - ì´ ${total}ê°œ íŒŒì¼`, 'info');

    for (let i = 0; i < total; i++) {
      const pf = pdfFiles[i];
      pf.status = 'processing'; renderFileList();
      pFill.style.width = `${(i / total) * 100}%`;
      try {
        log(`[${i+1}/${total}] ${pf.name}`);
        const text = await extractTextFromPDF(pf.file);
        document.getElementById('debugArea').textContent = `=== ${pf.name} ===\n${text}`;
        const data = parseContractData(text);
        if (data.storeName || data.businessNumber || data.storePhone) {
          data._fileName = pf.name; extractedData.push(data);
          pf.status = 'done'; log(`  âœ“ ${data.storeName || '(ìƒí˜¸ì—†ìŒ)'}`, 'success');
        } else { pf.status = 'error'; log(`  âœ— ë°ì´í„° ì—†ìŒ`, 'error'); }
      } catch (err) { pf.status = 'error'; log(`  âœ— ì˜¤ë¥˜: ${err.message}`, 'error'); }
      renderFileList(); pFill.style.width = `${((i+1)/total)*100}%`;
    }

    renderResultTable(); updateStats();
    log(`ì™„ë£Œ! ì„±ê³µ: ${extractedData.length}/${total}`, extractedData.length > 0 ? 'success' : 'error');
    btn.disabled = false; btn.innerHTML = '<span class="btn-icon">âš¡</span> ì „ì²´ ì¶”ì¶œ';
    document.getElementById('btnDownload').disabled = extractedData.length === 0;
    setTimeout(() => pBar.classList.remove('active'), 1000);
  }

  // ============================================================
  // í…Œì´ë¸”
  // ============================================================
  function renderResultTable() {
    const wrap = document.getElementById('tableWrap');
    document.getElementById('resultBadge').textContent = extractedData.length;
    const btnCopy = document.getElementById('btnCopy');
    if (extractedData.length === 0) {
      wrap.innerHTML = '<div class="empty-state"><div class="empty-icon">ğŸ“Š</div>ì¶”ì¶œ ê²°ê³¼ê°€ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤</div>';
      btnCopy.style.display = 'none'; return;
    }
    btnCopy.style.display = '';
    const headers = ['#','ì²´ê²°ì¼','ìƒí˜¸','ëŒ€í‘œì','ë§¤ì¥ì „í™”','íœ´ëŒ€ì „í™”','ì£¼ì†Œ','ì´ë©”ì¼','ìš´ì˜ì‹œê°„','ì€í–‰ëª…','ê³„ì¢Œë²ˆí˜¸','ëª…ì˜ì£¼','ì‚¬ì—…ìë²ˆí˜¸'];
    const keys = ['contractDate','storeName','representative','storePhone','mobilePhone','address','email','operatingHours','bankName','accountNumber','accountHolder','businessNumber'];
    let html = '<table><thead><tr>' + headers.map(h => `<th>${h}</th>`).join('') + '</tr></thead><tbody>';
    extractedData.forEach((d, i) => {
      html += '<tr>' + `<td class="row-num">${i+1}</td>` +
        keys.map(k => `<td${k==='address'?' class="address"':''} title="${(d[k]||'').replace(/"/g,'&quot;')}">${d[k]||'-'}</td>`).join('') + '</tr>';
    });
    wrap.innerHTML = html + '</tbody></table>';
  }

  // ============================================================
  // ì—‘ì…€ / í´ë¦½ë³´ë“œ
  // ============================================================
  function downloadExcel() {
    if (!extractedData.length) return;
    const headers = ['ì²´ê²°ì¼','ìƒí˜¸','ëŒ€í‘œì','ë§¤ì¥ì „í™”ë²ˆí˜¸','íœ´ëŒ€ì „í™”ë²ˆí˜¸','ì£¼ì†Œ','ì´ë©”ì¼','ìš´ì˜ì‹œê°„','ì€í–‰ëª…','ê³„ì¢Œë²ˆí˜¸','ëª…ì˜ì£¼','ì‚¬ì—…ìë²ˆí˜¸'];
    const keys = ['contractDate','storeName','representative','storePhone','mobilePhone','address','email','operatingHours','bankName','accountNumber','accountHolder','businessNumber'];
    const wsData = [headers, ...extractedData.map(d => keys.map(k => d[k]||''))];
    const wb = XLSX.utils.book_new();
    const ws = XLSX.utils.aoa_to_sheet(wsData);
    ws['!cols'] = [{wch:12},{wch:15},{wch:8},{wch:14},{wch:14},{wch:35},{wch:25},{wch:14},{wch:12},{wch:18},{wch:8},{wch:14}];
    XLSX.utils.book_append_sheet(wb, ws, 'ì œíœ´ì  ê³„ì•½ ë°ì´í„°');
    const d = new Date();
    XLSX.writeFile(wb, `ì œíœ´ì _ê³„ì•½ì¶”ì¶œ_${d.getFullYear()}${String(d.getMonth()+1).padStart(2,'0')}${String(d.getDate()).padStart(2,'0')}.xlsx`);
    log('ì—‘ì…€ ë‹¤ìš´ë¡œë“œ ì™„ë£Œ', 'success');
  }

  function copyToClipboard() {
    if (!extractedData.length) return;
    const headers = ['ì²´ê²°ì¼','ìƒí˜¸','ëŒ€í‘œì','ë§¤ì¥ì „í™”ë²ˆí˜¸','íœ´ëŒ€ì „í™”ë²ˆí˜¸','ì£¼ì†Œ','ì´ë©”ì¼','ìš´ì˜ì‹œê°„','ì€í–‰ëª…','ê³„ì¢Œë²ˆí˜¸','ëª…ì˜ì£¼','ì‚¬ì—…ìë²ˆí˜¸'];
    const keys = ['contractDate','storeName','representative','storePhone','mobilePhone','address','email','operatingHours','bankName','accountNumber','accountHolder','businessNumber'];
    let tsv = headers.join('\t') + '\n';
    extractedData.forEach(d => { tsv += keys.map(k => d[k]||'').join('\t') + '\n'; });
    navigator.clipboard.writeText(tsv).then(() => {
      log('í´ë¦½ë³´ë“œ ë³µì‚¬ ì™„ë£Œ (íƒ­ êµ¬ë¶„)', 'success');
      const btn = document.getElementById('btnCopy');
      const o = btn.innerHTML; btn.innerHTML = '<span class="btn-icon">âœ…</span> ë³µì‚¬ë¨!';
      setTimeout(() => btn.innerHTML = o, 1500);
    });
  }

  function clearAll() {
    pdfFiles = []; extractedData = [];
    renderFileList(); renderResultTable(); updateStats();
    document.getElementById('btnExtract').disabled = true;
    document.getElementById('btnDownload').disabled = true;
    document.getElementById('debugArea').textContent = '';
    log('ì´ˆê¸°í™” ì™„ë£Œ', 'info');
  }

  function log(msg, type = '') {
    const area = document.getElementById('logArea');
    const now = new Date();
    const t = `${String(now.getHours()).padStart(2,'0')}:${String(now.getMinutes()).padStart(2,'0')}:${String(now.getSeconds()).padStart(2,'0')}`;
    const line = document.createElement('div');
    line.className = `log-line ${type}`;
    line.innerHTML = `<span class="log-time">[${t}]</span>${msg}`;
    area.insertBefore(line, area.firstChild);
    while (area.children.length > 100) area.removeChild(area.lastChild);
  }
  function clearLog() { document.getElementById('logArea').innerHTML = ''; }
  function toggleDebug() { document.getElementById('debugArea').classList.toggle('visible'); }

  log('PDF ì œíœ´ì  ê³„ì•½ì„œ ì¶”ì¶œê¸° ì¤€ë¹„ ì™„ë£Œ', 'info');
</script>
</body>
</html>
